<!doctype html><html lang="en" class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="x-ua-compatible" content="ie=edge"><link rel="canonical" href="https://docs.pivotal.io/reference/task.html"><meta name="lang:clipboard.copy" content="Copy to clipboard"><meta name="lang:clipboard.copied" content="Copied to clipboard"><meta name="lang:search.language" content="en"><meta name="lang:search.pipeline.stopwords" content="True"><meta name="lang:search.pipeline.trimmer" content="True"><meta name="lang:search.result.none" content="No matching documents"><meta name="lang:search.result.one" content="1 matching document"><meta name="lang:search.result.other" content="# matching documents"><meta name="lang:search.tokenizer" content="[\s\-]+"><link rel="shortcut icon" href="../assets/icon.svg"><meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.3.0"><title>Task Reference</title><link rel="stylesheet" href="../assets/stylesheets/application.4031d38b.css"><link rel="stylesheet" href="../assets/stylesheets/application-palette.224b79ff.css"><meta name="theme-color" content="#009688"><script src="../assets/javascripts/modernizr.74668098.js"></script><link href="https://fonts.gstatic.com" rel="preconnect" crossorigin><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700|Ubuntu+Mono&display=swap"><style>body,input{font-family:"Source Sans Pro","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style><link rel="stylesheet" href="../assets/fonts/material-icons.css">
<style>
label.md-nav__link {
    font-weight: bold;
}

@media only screen and (min-width: 76.1875em) {
  label.md-nav__title.md-nav__title--site {
      display: none;
  }
}
.header-dropdown {
  display: inline-block;
  position: relative;
  margin-left: 10px;
  cursor: pointer;
}

.header-dropdown:hover .content,
.header-dropdown:hover .content:hover {
  display: block;
  visibility: visible;
  opacity: 1;
}

.header-dropdown .content {
  position: absolute;
  top: 100%;
  background-color: #009688;
  left: 0;
  display: none;
  z-index: 1;
  clear: both;
  padding: 10px;
}

.header-dropdown ul {
  padding: 0;
  margin: 0;
  line-height: 24px;
}

.header-dropdown ul li {
  list-style: none;
}

.md-header-nav__topic {
  overflow: visible;
}

.header-dropdown .pointer {
  height: 24px;
  width: 24px;
  display: inline-flex;
  vertical-align: middle;
  fill: white;
}

.md-typeset pre, .md-typeset code {
  font-size: 100%
}

.md-typeset table:not([class]) {
  font-size: 16px
}

.md-typeset > .codehilitetable {
  overflow: visible;
}

.md-typeset .md-footer-social {
    font-size: .64rem;
}

.md-footer-social {
    padding: .4rem 0;
}
</style>

<!-- Google Tag Manager -->
<script>
 (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
 new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
 j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
 })(window,document,'script','dataLayer','GTM-MW4LZHR');
</script>
</head><body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal"><svg class="md-svg"><defs><svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg></defs></svg> <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off"> <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off"> <label class="md-overlay" data-md-component="overlay" for="__drawer"></label><a href="#platform-automation-for-pcf-tasks" tabindex="1" class="md-skip">Skip to content </a><style>
    @media only screen and (max-width: 60em) {
        .md-header .secondary-header {
            display: none;
        }
    }
    @media only screen and (min-width: 60em) {
        .md-header {
            height: 7.4rem;
        }

        .md-header .md-header-nav {
            height: 5rem;
        }

        .md-header .md-header-nav .md-flex {
            height: 100%;
        }

        .md-header .md-header-nav .md-flex__cell {
            vertical-align: middle;
        }

        .md-header .md-header-nav .md-header-nav__title {
            font-size: 1.5rem;
            line-height: 5rem;
        }

        .md-header .secondary-header .md-flex__cell {
            width: 30rem;
            text-align: right;
        }

        .md-header .secondary-header .md-grid {
            padding: 0 .6rem;
        }

        .md-header .secondary-header .logo {
            text-align: left;
        }

        .md-header .secondary-header {
            height: 2.4rem;
            line-height: 3.0rem;
            background-color: #243640;
        }

        .md-header .secondary-header .sub {
            font-size: 13px;
        }

        .md-header .secondary-header .sub a {
            margin-right: 17px;
        }

        .global-header-title .pivotal-logo {
            fill: white;
            height: .9rem;
            margin-right: 17px;
        }

        .global-header-title .documentation-letters {
            fill: white;
            height: .6rem;
        }

        .md-sidebar[data-md-state=lock] {
            top: 7.4rem;
        }

        .md-main__inner {
            padding-top: 5rem;
        }
    }
</style>
<header class="md-header" data-md-component="header">
    <div class="secondary-header">
        <div class="md-flex md-grid">
            <div class="md-flex__cell logo">
            <a href="https://docs.pivotal.io" class="global-header-title" target="_blank">
            <svg class="pivotal-logo" xmlns="http://www.w3.org/2000/svg"
                 viewBox="0 0 174.72 40.94">
                <path class="a" d="M38.77,6h-6.2V0h6.2Zm0,34.24H32.56V10.41h6.22Z"></path>
                <path class="a"
                      d="M74.67,10.41,66,36.18c-1.49,4.22-4.15,4.76-6.3,4.76-3.19,0-5.11-1.47-6.24-4.75l-7.22-21.4H43.39V10.41h7.45l7.44,24c.33,1,.53,1.63,1.43,1.63s1.13-.62,1.43-1.63l7.59-24Z"></path>
                <path class="a"
                      d="M90,10.41c8.05,0,13.66,5.31,13.66,12.92V28c0,7.6-5.61,12.92-13.66,12.92S76.32,35.62,76.32,28V23.33c0-7.61,5.62-12.92,13.67-12.92M90,36c4.81,0,7.8-3.64,7.8-8V23.33c0-4.37-3-8-7.8-8-5.1,0-7.8,3.64-7.8,8V28c0,4.37,2.82,8,7.8,8"></path>
                <path class="a"
                      d="M153.32,11.36A53.46,53.46,0,0,0,141.8,10c-8.17,0-13.24,5.15-13.24,13.45v3.27c0,8.3,5.07,13.53,13.24,13.53.19,0,1.64,0,2.3-.06v-5l-2.3.07c-4.45,0-7.43-3.43-7.43-8.53V23.44c0-5.09,3-8.52,7.43-8.52a43.88,43.88,0,0,1,6.09.38l.33.08V40.24h6.22V12.4c0-.53,0-.74-1.13-1"></path>
                <rect class="a" x="160.44" width="6.22" height="40.24"></rect>
                <path class="a"
                      d="M10.92,0H0V40.24H6.47V5.59h3.79c.81,0,1.49,0,2.18.06,5.61.1,8.35,2.33,8.35,6.69,0,.17,0,.29,0,.47,0,4-2.21,6.71-8.32,6.71H10.67c0,1.55,0,4.41,0,5.41.63,0,1.22.06,1.82.06,8.78,0,15-3.45,15-12.11,0-.17,0-.35,0-.52C27.44,3.38,20.69,0,10.92,0"></path>
                <path class="a"
                      d="M114.7,4v6.43h10.13v4.82H114.7V32.61c0,2.73,1.74,2.8,4.26,2.8h5.87v4.83h-7.94c-5.87,0-8.48-2.35-8.48-7.63V4.84Z"></path>
                <path class="a"
                      d="M169.52,37.64a2.6,2.6,0,1,1,2.6,2.6A2.61,2.61,0,0,1,169.52,37.64Zm2.6-2.25a2.23,2.23,0,1,0,2.22,2.24A2.24,2.24,0,0,0,172.12,35.39ZM171.55,39h-.31V36.19h.8c.72,0,1.06.33,1.06.86a.82.82,0,0,1-.58.8l.74,1.17h-.36l-.68-1.1-.67,0Zm.51-1.34c.46,0,.75-.24.75-.62s-.25-.6-.79-.6h-.48V37.7Z"></path>
            </svg>
            <svg class="documentation-letters" xmlns="http://www.w3.org/2000/svg"
                 viewBox="0 0 358.62 30.84">
                <path class="a"
                      d="M3.71,37.26V7.45h9.52c9.25,0,15.06,6.75,15.06,14.92S22.48,37.26,13.23,37.26Zm21.9-14.89c0-7-4.47-12.6-12.38-12.6h-7V34.93h7C21.1,34.93,25.61,29.35,25.61,22.37Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a"
                      d="M33.52,22.37C33.52,13.66,39.24,7,48,7s14.48,6.7,14.48,15.41S56.72,37.79,48,37.79,33.52,31.09,33.52,22.37Zm26.28,0c0-7.55-4.64-13.09-11.8-13.09S36.21,14.82,36.21,22.37s4.6,13.1,11.79,13.1S59.8,29.88,59.8,22.37Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a"
                      d="M67.67,22.37C67.67,13.21,74.33,7,82.78,7a13.38,13.38,0,0,1,10.86,5.27L91.5,13.61a10.84,10.84,0,0,0-8.72-4.33c-7,0-12.42,5.32-12.42,13.09s5.45,13.1,12.42,13.1a10.82,10.82,0,0,0,8.72-4.34l2.19,1.34a13.51,13.51,0,0,1-10.91,5.32C74.33,37.79,67.67,31.54,67.67,22.37Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a"
                      d="M98.79,25.82V7.45h2.59V25.77c0,6,3.17,9.7,9,9.7s9-3.67,9-9.7V7.45H122V25.82c0,7.37-3.94,12-11.62,12S98.79,33.15,98.79,25.82Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a"
                      d="M154.75,37.26V10.66l-10.87,26.6h-1L132,10.66v26.6h-2.55V7.45h3.8l10.14,24.8,10.1-24.8h3.85V37.26Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a" d="M164.76,37.26V7.45h18.91V9.77H167.31v11h16v2.32h-16v11.8h16.36v2.33Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a" d="M211.29,37.26,192.52,11.65V37.26H190V7.45h2.59L211.25,32.7V7.45h2.54V37.26Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a" d="M228.81,37.26V9.77h-9.74V7.45h22.08V9.77h-9.74V37.26Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a"
                      d="M264.93,37.26,262,29.93H246.2l-2.95,7.33H240.3L252.51,7.45h3.17l12.2,29.81ZM254.11,10.17,247.05,27.6h14.08Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a" d="M276.78,37.26V9.77H267V7.45h22.07V9.77h-9.74V37.26Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a" d="M294.39,37.26V7.45h2.55V37.26Z" transform="translate(-3.71 -6.96)"></path>
                <path class="a"
                      d="M303.24,22.37C303.24,13.66,309,7,317.72,7s14.48,6.7,14.48,15.41-5.76,15.42-14.48,15.42S303.24,31.09,303.24,22.37Zm26.28,0c0-7.55-4.65-13.09-11.8-13.09s-11.8,5.54-11.8,13.09,4.61,13.1,11.8,13.1S329.52,29.88,329.52,22.37Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a" d="M359.83,37.26,341.06,11.65V37.26h-2.55V7.45h2.59L359.78,32.7V7.45h2.55V37.26Z"
                      transform="translate(-3.71 -6.96)"></path>
            </svg>
            </a></div>

            <div class="md-flex__cell sub">
                <a href="#">Support</a>
                <a href="#">Downloads</a>
            </div>
        </div>
    </div>
    <nav class="md-header-nav md-grid">
        <div class="md-flex">
            <div class="md-flex__cell md-flex__cell--shrink">
                <a href="https://docs.pivotal.io" title="Platform Automation"
                   class="md-header-nav__button md-logo">
                    
                        <img src="../assets/icon.svg" width="65" height="65">
                    
                </a>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
                <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch">
                <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
                    
                        
                            <span class="md-header-nav__topic">
                                Platform Automation
                                
                                    <span class="header-dropdown">
                                        <a href="testin/reference/task.html">2.1</a>
                                        <span class="pointer">
                                            <svg width="100%" height="100%" viewBox="0 0 24 24" fit="" preserveAspectRatio="xMidYMid meet"
                                               focusable="false"><path d="M18 9H6l6 6 6-6z" fill-rule="evenodd"></path></svg>
                                        </span>
                                        <span class="content">
                                            <ul>
                                              
                                                  <li> <a href="testin/reference/task.html">1.1</a></li>
                                              
                                                  <li> <a href="testin/reference/task.html">2.1</a></li>
                                              
                                                  <li> <a href="testin/reference/task.html">develop</a></li>
                                              
                                            </ul>
                                        </span>
                                    </span>
                                
                            </span>
                            <span class="md-header-nav__topic">
                                Tasks
                            </span>
                        
                    
                </div>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
                
                    
                        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
                        <div class="md-search" data-md-component="search" role="dialog"><label class="md-search__overlay" for="__search"></label><div class="md-search__inner" role="search"><form class="md-search__form" name="search"><input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active"> <label class="md-icon md-search__icon" for="__search"></label> <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button></form><div class="md-search__output"><div class="md-search__scrollwrap" data-md-scrollfix><div class="md-search-result" data-md-component="result"><div class="md-search-result__meta">Type to start searching</div><ol class="md-search-result__list"></ol></div></div></div></div></div>
                    
                
            </div>
            
                <div class="md-flex__cell md-flex__cell--shrink">
                    <div class="md-header-nav__source">
                        <a href="https://github.com/pivotal/docs-platform-automation/" title="Go to repository" class="md-source" data-md-source="github"><div class="md-source__icon"><svg viewBox="0 0 24 24" width="24" height="24"><use xlink:href="#__github" width="24" height="24"></use></svg></div><div class="md-source__repository">Help fix the docs!</div></a>
                    </div>
                </div>
            
        </div>
    </nav>
</header><div class="md-container"><main class="md-main"><div class="md-main__inner md-grid" data-md-component="container"><div class="md-sidebar md-sidebar--primary" data-md-component="navigation"><div class="md-sidebar__scrollwrap"><div class="md-sidebar__inner"><nav class="md-nav md-nav--primary" data-md-level="0"><label class="md-nav__title md-nav__title--site" for="__drawer"><a href="https://docs.pivotal.io" title="Platform Automation" class="md-nav__button md-logo"><img src="../assets/icon.svg" width="48" height="48"></a>Platform Automation</label><div class="md-nav__source"><a href="https://github.com/pivotal/docs-platform-automation/" title="Go to repository" class="md-source" data-md-source="github"><div class="md-source__icon"><svg viewBox="0 0 24 24" width="24" height="24"><use xlink:href="#__github" width="24" height="24"></use></svg></div><div class="md-source__repository">Help fix the docs!</div></a></div><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../index.html" title="Introduction" class="md-nav__link">Introduction</a></li><li class="md-nav__item"><a href="../downloading-and-testing.html" title="Downloading and Testing" class="md-nav__link">Downloading and Testing</a></li><li class="md-nav__item"><a href="../compatibility-and-versioning.html" title="Compatibility and Versioning" class="md-nav__link">Compatibility and Versioning</a></li><li class="md-nav__item"><a href="../release-notes.html" title="Release Notes" class="md-nav__link">Release Notes</a></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5"><label class="md-nav__link" for="nav-5">Reference Pipelines</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-5">Reference Pipelines</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../pipeline/resources.html" title="Retrieving External Dependencies" class="md-nav__link">Retrieving External Dependencies</a></li><li class="md-nav__item"><a href="../pipeline/multiple-products.html" title="Ops Manager + multiple products" class="md-nav__link">Ops Manager + multiple products</a></li><li class="md-nav__item"><a href="../pipeline/single-product.html" title="Ops Manager + a product" class="md-nav__link">Ops Manager + a product</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6"><label class="md-nav__link" for="nav-6">Before You Begin</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-6">Before You Begin</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../before-you-begin/git-repo-layout.html" title="Git Repository Layout" class="md-nav__link">Git Repository Layout</a></li><li class="md-nav__item"><a href="../before-you-begin/setup-s3-and-resources.html" title="Set Up S3 for File Storage" class="md-nav__link">Set Up S3 for File Storage</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7"><label class="md-nav__link" for="nav-7">How to Guides</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-7">How to Guides</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../how-to-guides/upgrade-existing-opsman.html" title="Upgrading an Existing Ops Manager" class="md-nav__link">Upgrading an Existing Ops Manager</a></li><li class="md-nav__item"><a href="../how-to-guides/install-opsman.html" title="Installing Ops Manager" class="md-nav__link">Installing Ops Manager</a></li></ul></nav></li><li class="md-nav__item md-nav__item--active md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8" checked><label class="md-nav__link" for="nav-8">References</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-8">References</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item md-nav__item--active"><input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc"><label class="md-nav__link md-nav__link--active" for="__toc">Tasks</label><a href="task.html" title="Tasks" class="md-nav__link md-nav__link--active">Tasks</a><nav class="md-nav md-nav--secondary"><label class="md-nav__title" for="__toc">Table of contents</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="#platform-automation-for-pcf-tasks" title="Platform Automation for PCF Tasks" class="md-nav__link">Platform Automation for PCF Tasks</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#apply-changes" title="apply-changes" class="md-nav__link">apply-changes</a></li><li class="md-nav__item"><a href="#apply-director-changes" title="apply-director-changes" class="md-nav__link">apply-director-changes</a></li><li class="md-nav__item"><a href="#assign-multi-stemcell" title="assign-multi-stemcell" class="md-nav__link">assign-multi-stemcell</a></li><li class="md-nav__item"><a href="#assign-stemcell" title="assign-stemcell" class="md-nav__link">assign-stemcell</a></li><li class="md-nav__item"><a href="#configure-authentication" title="configure-authentication" class="md-nav__link">configure-authentication</a></li><li class="md-nav__item"><a href="#configure-director" title="configure-director" class="md-nav__link">configure-director</a></li><li class="md-nav__item"><a href="#configure-ldap-authentication" title="configure-ldap-authentication" class="md-nav__link">configure-ldap-authentication</a></li><li class="md-nav__item"><a href="#configure-product" title="configure-product" class="md-nav__link">configure-product</a></li><li class="md-nav__item"><a href="#configure-saml-authentication" title="configure-saml-authentication" class="md-nav__link">configure-saml-authentication</a></li><li class="md-nav__item"><a href="#create-vm" title="create-vm" class="md-nav__link">create-vm</a></li><li class="md-nav__item"><a href="#credhub-interpolate" title="credhub-interpolate" class="md-nav__link">credhub-interpolate</a></li><li class="md-nav__item"><a href="#delete-installation" title="delete-installation" class="md-nav__link">delete-installation</a></li><li class="md-nav__item"><a href="#delete-vm" title="delete-vm" class="md-nav__link">delete-vm</a></li><li class="md-nav__item"><a href="#download-product" title="download-product" class="md-nav__link">download-product</a></li><li class="md-nav__item"><a href="#download-product-s3" title="download-product-s3" class="md-nav__link">download-product-s3</a></li><li class="md-nav__item"><a href="#export-installation" title="export-installation" class="md-nav__link">export-installation</a></li><li class="md-nav__item"><a href="#import-installation" title="import-installation" class="md-nav__link">import-installation</a></li><li class="md-nav__item"><a href="#make-git-commit" title="make-git-commit" class="md-nav__link">make-git-commit</a></li><li class="md-nav__item"><a href="#pre-deploy-check" title="pre-deploy-check" class="md-nav__link">pre-deploy-check</a></li><li class="md-nav__item"><a href="#stage-product" title="stage-product" class="md-nav__link">stage-product</a></li><li class="md-nav__item"><a href="#staged-config" title="staged-config" class="md-nav__link">staged-config</a></li><li class="md-nav__item"><a href="#staged-director-config" title="staged-director-config" class="md-nav__link">staged-director-config</a></li><li class="md-nav__item"><a href="#test" title="test" class="md-nav__link">test</a></li><li class="md-nav__item"><a href="#test-interpolate" title="test-interpolate" class="md-nav__link">test-interpolate</a></li><li class="md-nav__item"><a href="#upgrade-opsman" title="upgrade-opsman" class="md-nav__link">upgrade-opsman</a></li><li class="md-nav__item"><a href="#upload-and-stage-product" title="upload-and-stage-product" class="md-nav__link">upload-and-stage-product</a></li><li class="md-nav__item"><a href="#upload-product" title="upload-product" class="md-nav__link">upload-product</a></li><li class="md-nav__item"><a href="#upload-stemcell" title="upload-stemcell" class="md-nav__link">upload-stemcell</a></li></ul></nav></li></ul></nav></li><li class="md-nav__item"><a href="inputs-outputs.html" title="Inputs/Outputs" class="md-nav__link">Inputs/Outputs</a></li><li class="md-nav__item"><a href="running-commands-locally.html" title="Running Commands Locally" class="md-nav__link">Running Commands Locally</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9"><label class="md-nav__link" for="nav-9">Configuration Management</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-9">Configuration Management</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../configuration-management/configure-auth.html" title="Configure Auth" class="md-nav__link">Configure Auth</a></li><li class="md-nav__item"><a href="../configuration-management/creating-a-director-config-file.html" title="Creating a Director Config File" class="md-nav__link">Creating a Director Config File</a></li><li class="md-nav__item"><a href="../configuration-management/creating-a-product-config-file.html" title="Creating a Product Config File" class="md-nav__link">Creating a Product Config File</a></li><li class="md-nav__item"><a href="../configuration-management/configure-env.html" title="Configuring Env" class="md-nav__link">Configuring Env</a></li><li class="md-nav__item"><a href="../configuration-management/secrets-handling.html" title="Secrets Handling" class="md-nav__link">Secrets Handling</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10"><label class="md-nav__link" for="nav-10">Pipeline Design</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-10">Pipeline Design</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../pipeline-design/variables.html" title="Variables" class="md-nav__link">Variables</a></li><li class="md-nav__item"><a href="../pipeline-design/stemcell-handling.html" title="Stemcell Handling" class="md-nav__link">Stemcell Handling</a></li></ul></nav></li><li class="md-nav__item"><a href="../upgrade.html" title="About Upgrading Ops Manager" class="md-nav__link">About Upgrading Ops Manager</a></li><li class="md-nav__item"><a href="../report-an-issue.html" title="Report an Issue" class="md-nav__link">Report an Issue</a></li></ul></nav></div></div></div><div class="md-sidebar md-sidebar--secondary" data-md-component="toc"><div class="md-sidebar__scrollwrap"><div class="md-sidebar__inner"><nav class="md-nav md-nav--secondary"><label class="md-nav__title" for="__toc">Table of contents</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="#platform-automation-for-pcf-tasks" title="Platform Automation for PCF Tasks" class="md-nav__link">Platform Automation for PCF Tasks</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#apply-changes" title="apply-changes" class="md-nav__link">apply-changes</a></li><li class="md-nav__item"><a href="#apply-director-changes" title="apply-director-changes" class="md-nav__link">apply-director-changes</a></li><li class="md-nav__item"><a href="#assign-multi-stemcell" title="assign-multi-stemcell" class="md-nav__link">assign-multi-stemcell</a></li><li class="md-nav__item"><a href="#assign-stemcell" title="assign-stemcell" class="md-nav__link">assign-stemcell</a></li><li class="md-nav__item"><a href="#configure-authentication" title="configure-authentication" class="md-nav__link">configure-authentication</a></li><li class="md-nav__item"><a href="#configure-director" title="configure-director" class="md-nav__link">configure-director</a></li><li class="md-nav__item"><a href="#configure-ldap-authentication" title="configure-ldap-authentication" class="md-nav__link">configure-ldap-authentication</a></li><li class="md-nav__item"><a href="#configure-product" title="configure-product" class="md-nav__link">configure-product</a></li><li class="md-nav__item"><a href="#configure-saml-authentication" title="configure-saml-authentication" class="md-nav__link">configure-saml-authentication</a></li><li class="md-nav__item"><a href="#create-vm" title="create-vm" class="md-nav__link">create-vm</a></li><li class="md-nav__item"><a href="#credhub-interpolate" title="credhub-interpolate" class="md-nav__link">credhub-interpolate</a></li><li class="md-nav__item"><a href="#delete-installation" title="delete-installation" class="md-nav__link">delete-installation</a></li><li class="md-nav__item"><a href="#delete-vm" title="delete-vm" class="md-nav__link">delete-vm</a></li><li class="md-nav__item"><a href="#download-product" title="download-product" class="md-nav__link">download-product</a></li><li class="md-nav__item"><a href="#download-product-s3" title="download-product-s3" class="md-nav__link">download-product-s3</a></li><li class="md-nav__item"><a href="#export-installation" title="export-installation" class="md-nav__link">export-installation</a></li><li class="md-nav__item"><a href="#import-installation" title="import-installation" class="md-nav__link">import-installation</a></li><li class="md-nav__item"><a href="#make-git-commit" title="make-git-commit" class="md-nav__link">make-git-commit</a></li><li class="md-nav__item"><a href="#pre-deploy-check" title="pre-deploy-check" class="md-nav__link">pre-deploy-check</a></li><li class="md-nav__item"><a href="#stage-product" title="stage-product" class="md-nav__link">stage-product</a></li><li class="md-nav__item"><a href="#staged-config" title="staged-config" class="md-nav__link">staged-config</a></li><li class="md-nav__item"><a href="#staged-director-config" title="staged-director-config" class="md-nav__link">staged-director-config</a></li><li class="md-nav__item"><a href="#test" title="test" class="md-nav__link">test</a></li><li class="md-nav__item"><a href="#test-interpolate" title="test-interpolate" class="md-nav__link">test-interpolate</a></li><li class="md-nav__item"><a href="#upgrade-opsman" title="upgrade-opsman" class="md-nav__link">upgrade-opsman</a></li><li class="md-nav__item"><a href="#upload-and-stage-product" title="upload-and-stage-product" class="md-nav__link">upload-and-stage-product</a></li><li class="md-nav__item"><a href="#upload-product" title="upload-product" class="md-nav__link">upload-product</a></li><li class="md-nav__item"><a href="#upload-stemcell" title="upload-stemcell" class="md-nav__link">upload-stemcell</a></li></ul></nav></li></ul></nav></div></div></div><div class="md-content"><article class="md-content__inner md-typeset"><a href="https://github.com/pivotal/docs-platform-automation/edit/develop/docs/reference/task.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a><h1>Tasks</h1><h2 id="platform-automation-for-pcf-tasks">Platform Automation for PCF Tasks</h2>
<p>This document lists each Platform Automation for PCF task,
and provides information about their intentions, inputs, and outputs.</p>
<p>The tasks are presented, in their entirety,
as they are found in the product.</p>
<p>The docker image can be used to invoke the commands in each task locally.
Use <code>--help</code> for more information. To learn more see the <a href="running-commands-locally.html">running-commands-locally</a> section.</p>
<h3 id="apply-changes">apply-changes</h3>
<p>Triggers an install on the Ops Manager described by the auth file.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>
    <span class="no">om --env env/&quot;${ENV_FILE}&quot; apply-changes</span>
</pre></div>
</td></tr></table>

<h3 id="apply-director-changes">apply-director-changes</h3>
<p><code>apply-changes</code> can also be used to trigger an install for just the BOSH Director
with the <code>--skip-deploy-products</code>/<code>-sdp</code> flag.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>
    <span class="no">om --env env/&quot;${ENV_FILE}&quot; apply-changes \</span>
       <span class="no">--skip-deploy-products</span>
</pre></div>
</td></tr></table>

<h3 id="assign-multi-stemcell">assign-multi-stemcell</h3>
<p><code>assign-multi-stemcell</code> assigns multiple stemcells to a provided product.
This feature is only available in OpsMan 2.6+.
For more information on how to utilize this workflow,
check out the <a href="../pipeline-design/stemcell-handling.html">Stemcell Handling</a> topic.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># This feature is only available in OpsMan 2.6+.</span>
<span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span> <span class="c1"># contains the configuration file for assign-multi-stemcell command</span>
  <span class="c1"># - Example config:</span>
  <span class="c1"># ---</span>
  <span class="c1"># product: cf</span>
  <span class="c1"># stemcell:</span>
  <span class="c1"># - ubuntu-trusty:1234.6</span>
  <span class="c1"># - ubuntu-xenial:latest</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

  <span class="nt">CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `assign-multi-stemcell-config` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>
    <span class="no">om --env env/&quot;${ENV_FILE}&quot; assign-multi-stemcell \</span>
       <span class="no">--config config/&quot;$CONFIG_FILE&quot;</span>
</pre></div>
</td></tr></table>

<h3 id="assign-stemcell">assign-stemcell</h3>
<p><code>assign-stemcell</code> assigns a stemcell to a provided product. For more information on how to utilize
this workflow, check out the <a href="../pipeline-design/stemcell-handling.html">Stemcell Handling</a> topic.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span> <span class="c1"># contains the configuration file for assign-stemcell command</span>
  <span class="c1"># - Can consume the output of `download-product` task directly</span>
  <span class="c1"># - Example config:</span>
  <span class="c1"># ---</span>
  <span class="c1"># product: cf</span>
  <span class="c1"># stemcell: 3468.86</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

  <span class="nt">CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `assign-stemcell-config` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>
    <span class="no">om --env env/&quot;${ENV_FILE}&quot; assign-stemcell \</span>
       <span class="no">--config config/&quot;$CONFIG_FILE&quot;</span>
</pre></div>
</td></tr></table>

<h3 id="configure-authentication">configure-authentication</h3>
<p>Configures Ops Manager with an internal userstore and admin user account.
See <a href="#configure-saml-authentication">configure-saml-authentication</a> to configure an external SAML user store,
and <a href="#configure-ldap-authentication">configure-ldap-authentication</a> to configure with LDAP.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span> <span class="c1"># contains the auth configuration</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

  <span class="nt">AUTH_CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">auth.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the authorization config YAML</span>
  <span class="c1"># - The path is relative to root of the `config` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>
    <span class="no">om --env env/&quot;${ENV_FILE}&quot; configure-authentication \</span>
       <span class="no">--config config/&quot;${AUTH_CONFIG_FILE}&quot;</span>
</pre></div>
</td></tr></table>

<p>For details on the config file expected in the <code>config</code> input,
please see <a href="../configuration-management/configure-auth.html#generating-an-auth-file">Generating an Auth File</a>.</p>
<h3 id="configure-director">configure-director</h3>
<p>Configures the BOSH Director with settings from a config file.
See <a href="#staged-director-config">staged-director-config</a>,
which can extract a config file.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span> <span class="c1"># contains the director configuration file</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vars</span> <span class="c1"># variable files to be made available</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">secrets</span>
  <span class="c1"># secret files to be made available</span>
  <span class="c1"># separate from vars, so they can be store securely</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ops-files</span> <span class="c1"># operations files to custom configure the product</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">VARS_FILES</span><span class="p">:</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - Filepath to the Ops Manager vars yaml file</span>
  <span class="c1"># - The path is relative to root of the task build,</span>
  <span class="c1">#   so `vars` and `secrets` can be used.</span>

  <span class="nt">OPS_FILES</span><span class="p">:</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - Filepath to the Ops Manager operations yaml files</span>
  <span class="c1"># - The path is relative to root of the task build</span>

  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

  <span class="nt">DIRECTOR_CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">director.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath to the director configuration yaml file</span>
  <span class="c1"># - The path is relative to the root of the `config` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>

    <span class="no">vars_files_args=(&quot;&quot;)</span>
    <span class="no">for vf in ${VARS_FILES}</span>
    <span class="no">do</span>
      <span class="no">vars_files_args+=(&quot;--vars-file ${vf}&quot;)</span>
    <span class="no">done</span>

    <span class="no">ops_files_args=(&quot;&quot;)</span>
    <span class="no">for of in ${OPS_FILES}</span>
    <span class="no">do</span>
      <span class="no">ops_files_args+=(&quot;--ops-file ${of}&quot;)</span>
    <span class="no">done</span>

    <span class="no"># ${vars_files_args[@] needs to be globbed to pass through properly</span>
    <span class="no"># ${ops_files_args[@] needs to be globbed to pass through properly</span>
    <span class="no"># shellcheck disable=SC2068</span>
    <span class="no">om --env env/&quot;${ENV_FILE}&quot; configure-director \</span>
       <span class="no">--config &quot;config/${DIRECTOR_CONFIG_FILE}&quot; \</span>
       <span class="no">${vars_files_args[@]} \</span>
       <span class="no">${ops_files_args[@]}</span>
</pre></div>
</td></tr></table>

<div class="admonition warning">
<p class="admonition-title">GCP with service account</p>
<p>For GCP, if service account is used, the property associated_service_account has to be set explicitly in the <code>iaas_configuration</code> section.</p>
</div>
<h3 id="configure-ldap-authentication">configure-ldap-authentication</h3>
<p>Configures Ops Manager with an external LDAP user store and admin user account.
See <a href="#configure-authentication">configure-authentication</a> to configure an internal user store,
and <a href="#configure-saml-authentication">configure-saml-authentication</a> to configure with SAML.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span> <span class="c1"># contains the auth configuration</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

  <span class="nt">AUTH_CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">auth.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the authorization config YAML</span>
  <span class="c1"># - The path is relative to root of the `config` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>
    <span class="no">om --env env/&quot;${ENV_FILE}&quot; configure-ldap-authentication \</span>
    <span class="no">--config config/&quot;${AUTH_CONFIG_FILE}&quot;</span>
</pre></div>
</td></tr></table>

<p>For more details on using LDAP,
please refer to the <a href="https://docs.pivotal.io/pivotalcf/opsguide/auth-sso.html#configure-ldap">Ops Manager documentation</a>.</p>
<p>For details on the config file expected in the <code>config</code> input,
please see <a href="../configuration-management/configure-auth.html#generating-an-auth-file">Generating an Auth File</a>.</p>
<h3 id="configure-product">configure-product</h3>
<p>Configures an individual, staged product with settings from a config file.</p>
<p>Not to be confused with Ops Manager's
built-in <a href="https://docs.pivotal.io/pivotalcf/customizing/backup-restore/restore-pcf-bbr.html#deploy-import">import</a>,
which reads all deployed products and configurations from a single opaque file,
intended for import as part of backup/restore and upgrade lifecycle processes.</p>
<p>See <a href="#staged-config">staged-config</a>,
which can extract a config file,
and <a href="#upload-and-stage-product">upload-and-stage-product</a>,
which can stage a product that's been uploaded.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span> <span class="c1"># contains the product configuration file</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vars</span> <span class="c1"># variable files to be made available</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">secrets</span>
  <span class="c1"># secret files to be made available</span>
  <span class="c1"># separate from vars, so they can be store securely</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ops-files</span> <span class="c1"># operations files to custom configure the product</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">CONFIG_FILE</span><span class="p">:</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath to the product configuration yaml file</span>
  <span class="c1"># - The path is relative to the root of the `config` input</span>

  <span class="nt">VARS_FILES</span><span class="p">:</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - Filepath to the product configuration vars yaml file</span>
  <span class="c1"># - The path is relative to root of the task build,</span>
  <span class="c1">#   so `vars` and `secrets` can be used.</span>

  <span class="nt">OPS_FILES</span><span class="p">:</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - Filepath to the product configuration operations yaml files</span>
  <span class="c1"># - The path is relative to root of the task build</span>

  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>

    <span class="no">vars_files_args=(&quot;&quot;)</span>
    <span class="no">for vf in ${VARS_FILES}</span>
    <span class="no">do</span>
      <span class="no">vars_files_args+=(&quot;--vars-file ${vf}&quot;)</span>
    <span class="no">done</span>

    <span class="no">ops_files_args=(&quot;&quot;)</span>
    <span class="no">for of in ${OPS_FILES}</span>
    <span class="no">do</span>
      <span class="no">ops_files_args+=(&quot;--ops-file ${of}&quot;)</span>
    <span class="no">done</span>

    <span class="no"># ${vars_files_args[@] needs to be globbed to pass through properly</span>
    <span class="no"># ${ops_files_args[@] needs to be globbed to pass through properly</span>
    <span class="no"># shellcheck disable=SC2068</span>
    <span class="no">om --env env/&quot;${ENV_FILE}&quot; configure-product \</span>
       <span class="no">--config &quot;config/${CONFIG_FILE}&quot; \</span>
       <span class="no">${vars_files_args[@]} \</span>
       <span class="no">${ops_files_args[@]}</span>
</pre></div>
</td></tr></table>

<h3 id="configure-saml-authentication">configure-saml-authentication</h3>
<p>Configures Ops Manager with an external SAML user store and admin user account.
See <a href="#configure-authentication">configure-authentication</a> to configure an internal user store,
and <a href="#configure-ldap-authentication">configure-ldap-authentication</a> to configure with LDAP.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span> <span class="c1"># contains the auth configuration</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

  <span class="nt">AUTH_CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">auth.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the authorization config YAML</span>
  <span class="c1"># - The path is relative to root of the `config` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>
    <span class="no">om --env env/&quot;${ENV_FILE}&quot; configure-saml-authentication \</span>
    <span class="no">--config config/&quot;${AUTH_CONFIG_FILE}&quot;</span>
</pre></div>
</td></tr></table>

<p>Configuring SAML has two different auth flows for the UI and the task.
The UI will have a browser based login flow.
The CLI will require <code>client-id</code> and <code>client-secret</code> as it cannot do a browser login flow.</p>
<p>For more details on using SAML,
please refer to the <a href="https://docs.pivotal.io/pivotalcf/2-2/opsguide/config-rbac.html#enable-saml">Ops Manager documentation</a></p>
<p>For details on the config file expected in the <code>config</code> input,
please see <a href="../configuration-management/configure-auth.html#generating-an-auth-file">Generating an Auth File</a>.</p>
<h3 id="create-vm">create-vm</h3>
<p>Creates an unconfigured Ops Manager VM.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">state</span> <span class="c1"># contains the state for the vm</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span> <span class="c1"># contains the product configuration file</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">image</span> <span class="c1"># contains the image file to be installed</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vars</span> <span class="c1"># variable files to be made available</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">secrets</span>
  <span class="c1"># secret files to be made available</span>
  <span class="c1"># separate from vars, so they can be store securely</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">outputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">generated-state</span> <span class="c1">#contains the updated state file</span>


<span class="nt">params</span><span class="p">:</span>
  <span class="nt">VARS_FILES</span><span class="p">:</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - Filepath to the Ops Manager vars yaml file</span>
  <span class="c1"># - The path is relative to root of the task build,</span>
  <span class="c1">#   so `vars` and `secrets` can be used.</span>

  <span class="nt">OPSMAN_CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">opsman.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the opsman config YAML</span>
  <span class="c1"># - The path is relative to root of the `config` input</span>

  <span class="nt">STATE_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">state.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the state yaml file</span>
  <span class="c1"># - The path is relative to root of the `state` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>

    <span class="no">vars_files_args=(&quot;&quot;)</span>
    <span class="no">for vf in ${VARS_FILES}</span>
    <span class="no">do</span>
      <span class="no">vars_files_args+=(&quot;--vars-file ${vf}&quot;)</span>
    <span class="no">done</span>

    <span class="no">generated_state_path=&quot;generated-state/$(basename &quot;$STATE_FILE&quot;)&quot;</span>
    <span class="no">if [ -e &quot;state/$STATE_FILE&quot; ]; then</span>
      <span class="no">cp &quot;state/$STATE_FILE&quot; &quot;$generated_state_path&quot;</span>
    <span class="no">fi</span>

    <span class="no">export IMAGE_FILE</span>
    <span class="no">IMAGE_FILE=&quot;$(find image/*.{yml,ova,raw} 2&gt;/dev/null | head -n1)&quot;</span>

    <span class="no">if [ -z &quot;$IMAGE_FILE&quot; ]; then</span>
      <span class="no">echo &quot;No image file found in image input.&quot;</span>
      <span class="no">echo &quot;Contents of image input:&quot;</span>
      <span class="no">ls -al image</span>
      <span class="no">exit 1</span>
    <span class="no">fi</span>

    <span class="no"># ${vars_files_args[@] needs to be globbed to split properly</span>
    <span class="no"># shellcheck disable=SC2068</span>
    <span class="no">p-automator create-vm \</span>
    <span class="no">--config config/&quot;${OPSMAN_CONFIG_FILE}&quot; \</span>
    <span class="no">--image-file &quot;${IMAGE_FILE}&quot;  \</span>
    <span class="no">--state-file &quot;$generated_state_path&quot; \</span>
    <span class="no">${vars_files_args[@]}</span>
</pre></div>
</td></tr></table>

<p>This task requires a config file specific to the IaaS being deployed to.
Please see the <a href="inputs-outputs.html#ops-manager-config">configuration</a> page for more specific examples.</p>
<p>The task does specific CLI commands for the creation of the Ops Manager VM on each IAAS. See below for more information:</p>
<p><strong>AWS</strong></p>
<ol>
<li>Requires the image YAML file from Pivnet</li>
<li>Validates the existence of the VM if defined in the statefile, if so do nothing</li>
<li>Chooses the correct ami to use based on the provided image YAML file from Pivnet</li>
<li>Creates the vm configured via opsman config and the image YAML. This only attaches existing infrastructure to a newly created VM. This does not create any new resources</li>
<li>The public IP address, if provided, is assigned after successful creation</li>
</ol>
<p><strong>Azure</strong></p>
<ol>
<li>Requires the image YAML file from Pivnet</li>
<li>Validates the existence of the VM if defined in the statefile, if so do nothing</li>
<li>Copies the image (of the OpsMan VM from the specified region) as a blob into the specified storage account</li>
<li>Creates the Ops Manager image</li>
<li>Creates a VM from the image. This will use unmanaged disk (if specified), and assign a public and/or private IP. This only attaches existing infrastructure to a newly createdVM. This does not create any new resources.</li>
</ol>
<p><strong>GCP</strong></p>
<ol>
<li>Requires the image YAML file from Pivnet</li>
<li>Validates the existence of the VM if defined in the statefile, if so do nothing</li>
<li>Creates a compute image based on the region specific Ops Manager source URI in the specified Ops Manager account</li>
<li>Creates a VM from the image. This will assign a public and/or private IP address, VM sizing, and tags. This does not create any new resources.</li>
</ol>
<p><strong>Openstack</strong></p>
<ol>
<li>Requires the image YAML file from Pivnet</li>
<li>Validates the existence of the VM if defined in the statefile, if so do nothing</li>
<li>Recreates the image in openstack if it already exists to validate we are using the correct version of the image</li>
<li>Creates a VM from the image. This does not create any new resources</li>
<li>The public IP address, if provided, is assigned after successful creation</li>
</ol>
<p><strong>Vsphere</strong></p>
<ol>
<li>Requires the OVA image from Pivnet</li>
<li>Validates the existence of the VM if defined in the statefile, if so do nothing</li>
<li>Build ipath from the provided datacenter, folder, and vmname provided in the config file. The created VM is stored on the generated path. If folder is not provided, the vm will be placed in the datacenter.</li>
<li>Creates a VM from the image provided to the <code>create-vm</code> command. This does not create any new resources</li>
</ol>
<h3 id="credhub-interpolate">credhub-interpolate</h3>
<p>Interpolate credhub entries into configuration files</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">files</span>
<span class="c1"># contains YAML files with extension `.yml`.</span>
<span class="c1"># Each one of these files will have their values interpolated from credhub.</span>
<span class="c1"># For examples, run: `credhub interpolate --help`</span>
<span class="c1"># (minimum version &gt;= 2.1.0 required)</span>

<span class="nt">outputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolated-files</span>
<span class="c1"># Contains only yaml files found and interpolated by this task.</span>
<span class="c1"># Maintains the filestructure of the `files` input.</span>

<span class="c1"># all params are required to be filled out</span>
<span class="nt">params</span><span class="p">:</span>

  <span class="nt">CREDHUB_CLIENT</span><span class="p">:</span>
  <span class="nt">CREDHUB_SECRET</span><span class="p">:</span>
  <span class="nt">CREDHUB_SERVER</span><span class="p">:</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Credentials to talk to credhub server</span>

  <span class="nt">CREDHUB_CA_CERT</span><span class="p">:</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - This is only necessary if your Concourse worker</span>
  <span class="c1">#   is not already configured to trust the CA used for Credhub</span>

  <span class="nt">PREFIX</span><span class="p">:</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Prefix flag used by credhub interpolate</span>

  <span class="nt">INTERPOLATION_PATHS</span><span class="p">:</span> <span class="s">&#39;.&#39;</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Path the contains the files to read from</span>
  <span class="c1"># - This is a space separated list of directories</span>
  <span class="c1">#   the paths are all evaluated relative to files/</span>

  <span class="nt">SKIP_MISSING</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="c1"># Optional</span>
  <span class="c1"># Change to false to have strict interpolation</span>
  <span class="c1"># and fail if params are missing from vars</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -euo pipefail</span>

    <span class="no"># NOTE: The credhub cli does not ignore empty/null environment variables.</span>
    <span class="no"># https://github.com/cloudfoundry-incubator/credhub-cli/issues/68</span>
    <span class="no">if [ -z &quot;$CREDHUB_CA_CERT&quot; ]; then</span>
      <span class="no">unset CREDHUB_CA_CERT</span>
    <span class="no">fi</span>

    <span class="no">credhub --version</span>

    <span class="no">if [ -z &quot;$PREFIX&quot; ]; then</span>
      <span class="no">echo &quot;Please specify a PREFIX. It is required.&quot;</span>
      <span class="no">exit 1</span>
    <span class="no">fi</span>

    <span class="no"># $INTERPOLATION_PATHS needs to be globbed to read multiple files</span>
    <span class="no"># shellcheck disable=SC2086</span>
    <span class="no">files=$(cd files &amp;&amp; find $INTERPOLATION_PATHS -type f -name &#39;*.yml&#39; -follow)</span>

    <span class="no">if [ &quot;$SKIP_MISSING&quot; ]; then</span>
      <span class="no">export SKIP_MISSING=&quot;--skip-missing&quot;</span>
    <span class="no">else</span>
      <span class="no">export SKIP_MISSING=&quot;&quot;</span>
    <span class="no">fi</span>

    <span class="no">for file in $files; do</span>
      <span class="no">echo &quot;interpolating files/$file&quot;</span>
      <span class="no">mkdir -p interpolated-files/&quot;$(dirname &quot;$file&quot;)&quot;</span>
      <span class="no">credhub interpolate --prefix &quot;$PREFIX&quot; \</span>
      <span class="no">--file files/&quot;$file&quot; &quot;$SKIP_MISSING&quot; \</span>
      <span class="no">&gt; interpolated-files/&quot;$file&quot;</span>
    <span class="no">done</span>
</pre></div>
</td></tr></table>

<p>This task requires a valid credhub with UAA client and secret. For information on how to
set this up, see <a href="../configuration-management/secrets-handling.html">Secrets Handling</a></p>
<h3 id="delete-installation">delete-installation</h3>
<p>Delete the Ops Manager Installation</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>
    <span class="no">om --env env/&quot;${ENV_FILE}&quot; delete-installation --force</span>
</pre></div>
</td></tr></table>

<h3 id="delete-vm">delete-vm</h3>
<p>Deletes the Ops Manager VM instantiated by <a href="#create-vm">create-vm</a>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">state</span> <span class="c1"># contains the state for the vm</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span> <span class="c1"># contains the product configuration file</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vars</span> <span class="c1"># variable files to be made available</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">secrets</span>
  <span class="c1"># secret files to be made available</span>
  <span class="c1"># separate from vars, so they can be store securely</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">outputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">generated-state</span> <span class="c1">#contains the updated state file</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">VARS_FILES</span><span class="p">:</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - Filepath to the Ops Manager vars yaml file</span>
  <span class="c1"># - The path is relative to root of the task build,</span>
  <span class="c1">#   so `vars` and `secrets` can be used.</span>

  <span class="nt">STATE_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">state.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the state yaml file</span>
  <span class="c1"># - The path is relative to root of the `state` input</span>

  <span class="nt">OPSMAN_CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">opsman.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the opsman config YAML</span>
  <span class="c1"># - The path is relative to root of the `config` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>

    <span class="no">vars_files_args=(&quot;&quot;)</span>
    <span class="no">for vf in ${VARS_FILES}</span>
    <span class="no">do</span>
      <span class="no">vars_files_args+=(&quot;--vars-file ${vf}&quot;)</span>
    <span class="no">done</span>

    <span class="no">generated_state_path=&quot;generated-state/$(basename &quot;$STATE_FILE&quot;)&quot;</span>
    <span class="no">cp &quot;state/$STATE_FILE&quot; &quot;$generated_state_path&quot;</span>

    <span class="no"># ${vars_files_args[@] needs to be globbed to split properly</span>
    <span class="no"># shellcheck disable=SC2068</span>
    <span class="no">p-automator delete-vm \</span>
    <span class="no">--state-file &quot;$generated_state_path&quot; \</span>
    <span class="no">--config config/&quot;$OPSMAN_CONFIG_FILE&quot; \</span>
    <span class="no">${vars_files_args[@]}</span>
</pre></div>
</td></tr></table>

<p>This task requires the <a href="inputs-outputs.html#state">state file</a> generated <a href="#create-vm">create-vm</a>.</p>
<p>The task does specific CLI commands for the deletion of the Ops Manager VM and resources on each IAAS. See below for more information:</p>
<p><strong>AWS</strong></p>
<ol>
<li>Deletes the VM</li>
</ol>
<p><strong>Azure</strong></p>
<ol>
<li>Deletes the VM</li>
<li>Attempts to delete the associated disk</li>
<li>Attempts to delete the associated nic</li>
<li>Attempts to delete the associated image</li>
</ol>
<p><strong>GCP</strong></p>
<ol>
<li>Deletes the VM</li>
<li>Attempts to delete the associated image</li>
</ol>
<p><strong>Openstack</strong></p>
<ol>
<li>Deletes the VM</li>
<li>Attempts to delete the associated image</li>
</ol>
<p><strong>vSphere</strong></p>
<ol>
<li>Deletes the VM</li>
</ol>
<h3 id="download-product">download-product</h3>
<div class="admonition warning">
<p class="admonition-title">Ops Manager 2.5</p>
<p>The filename for the artifact downloaded from Ops Manager is changed! If your resources or pipelines
 have a regex for the Ops Manager filename, you <strong>may</strong> be affected. (Please see
 Ops Manager's <a href="https://community.pivotal.io/s/article/ops-manager-2-5-changing-the-file-naming-scheme-might-break-the-pipeline-jobs">official notice</a>
 for more information)</p>
</div>
<p>Downloads a product specified in a config file from Pivnet.
Optionally, also downloads the latest stemcell for that product.</p>
<p>Downloads are cached, so files are not re-downloaded each time.</p>
<p>Outputs can be persisted to an S3-compatible blobstore using a <code>put</code> to an appropriate resource
for later use with the <a href="task.html#download-product-s3"><code>download-product-s3</code></a>,
or used directly as inputs to <a href="#upload-and-stage-product">upload-and-stage-product</a>
and <a href="#upload-stemcell">upload-stemcell</a> tasks.</p>
<p>This task requires a <a href="inputs-outputs.html#download-product-config">download-product config file</a>.</p>
<p>If S3 configuration is present in the <a href="inputs-outputs.html#download-product-config">download-product config file</a>,
the slug and version of the downloaded product file will be prepended in brackets to the filename.<br />
For example:</p>
<ul>
<li>
<p>original-pivnet-filenames:
  <table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">ops</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="n">aws</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="n">build</span><span class="p">.</span><span class="mi">123</span><span class="p">.</span><span class="n">yml</span>
<span class="n">cf</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="n">build</span><span class="p">.</span><span class="mi">45</span><span class="p">.</span><span class="n">pivotal</span>
</pre></div>
</td></tr></table></p>
</li>
<li>
<p>download-product-filenames if S3 configuration is present:
  <table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span><span class="n">ops</span><span class="o">-</span><span class="n">manager</span><span class="p">,</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="p">]</span><span class="n">ops</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="n">aws</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="n">build</span><span class="p">.</span><span class="mi">123</span><span class="p">.</span><span class="n">yml</span>
<span class="p">[</span><span class="n">elastic</span><span class="o">-</span><span class="n">runtime</span><span class="p">,</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="p">]</span><span class="n">cf</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="n">build</span><span class="p">.</span><span class="mi">45</span><span class="p">.</span><span class="n">pivotal</span>
</pre></div>
</td></tr></table></p>
</li>
</ul>
<p>This is to allow the same config parameters
that let us select a file from Pivnet
select it again when pulling from S3.
Note that the filename will be unchanged
if S3 keys are not present in the configuration file.
This avoids breaking current pipelines.</p>
<div class="admonition warning">
<p class="admonition-title">When using the s3 resource in concourse</p>
<p>If you are using a <code>regexp</code> in your s3 resource definition that explicitly requires the pivnet filename to be the <em>start</em> of the
regex, (i.e., the pattern starts with <code>^</code>) this won't work when using S3 config.
The new file format preserves the original filename, so it is still possible to match on that -
but if you need to match from the beginning of the filename, that will have been replaced by the prefix described above.</p>
</div>
<div class="admonition info">
<p class="admonition-title">When specifying PAS-Windows</p>
<p>This task will automatically download and inject the winfs for pas-windows.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">When specifying PAS-Windows on Vsphere</p>
<p>This task cannot download the stemcell for pas-windows on vSphere.
To build this stemcell manually, please reference the
<a href="https://docs.pivotal.io/pivotalcf/windows/index.html#install">Creating a vSphere Windows Stemcell</a> guide
in Pivotal Documentation.</p>
</div>
<div class="admonition info">
<p class="admonition-title">When only downloading from Pivnet</p>
<p>When the download product config only has Pivnet credentials,
it will not add the prefix to the downloaded product.
For example, <code>example-product.pivotal</code> from Pivnet will be outputed
as <code>example-product.pivotal</code>.</p>
</div>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span> <span class="c1"># contains download-file config file</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vars</span> <span class="c1"># variable files to be made available</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">secrets</span>
  <span class="c1"># secret files to be made available</span>
  <span class="c1"># separate from vars, so they can be store securely</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">outputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">downloaded-product</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">downloaded-stemcell</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">assign-stemcell-config</span>

<span class="nt">caches</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">downloaded-files</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">download-config.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath to the product configuration yaml file</span>
  <span class="c1"># - The path is relative to the root of the `config` input</span>

  <span class="nt">VARS_FILES</span><span class="p">:</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - Filepath to the product configuration vars yaml file</span>
  <span class="c1"># - The path is relative to root of the task build,</span>
  <span class="c1">#   so `vars` and `secrets` can be used.</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>

    <span class="no">vars_files_args=(&quot;&quot;)</span>
    <span class="no">for vf in ${VARS_FILES}</span>
    <span class="no">do</span>
      <span class="no">vars_files_args+=(&quot;--vars-file ${vf}&quot;)</span>
    <span class="no">done</span>

    <span class="no"># ${vars_files_args[@] needs to be globbed to pass through properly</span>
    <span class="no"># shellcheck disable=SC2068</span>
    <span class="no">om download-product \</span>
       <span class="no">--config config/&quot;${CONFIG_FILE}&quot; ${vars_files_args[@]} \</span>
       <span class="no">--output-directory downloaded-files</span>

    <span class="no">{ printf &quot;\nReading product details...&quot;; } 2&gt; /dev/null</span>
    <span class="no"># shellcheck disable=SC2068</span>
    <span class="no">product_slug=$(om interpolate \</span>
      <span class="no">--config config/&quot;${CONFIG_FILE}&quot; ${vars_files_args[@]} \</span>
      <span class="no">--path /pivnet-product-slug)</span>

    <span class="no">product_file=$(om interpolate \</span>
      <span class="no">--config downloaded-files/download-file.json \</span>
      <span class="no">--path /product_path)</span>

    <span class="no">stemcell_file=$(om interpolate \</span>
      <span class="no">--config downloaded-files/download-file.json \</span>
      <span class="no">--path /stemcell_path?)</span>

    <span class="no">{ printf &quot;\nChecking if product needs winfs injected...&quot;; } 2&gt; /dev/null</span>
    <span class="no">if [ &quot;$product_slug&quot; == &quot;pas-windows&quot; ]; then</span>
      <span class="no">TILE_FILENAME=&quot;$(basename &quot;$product_file&quot;)&quot;</span>

      <span class="no"># The winfs-injector determines the necessary windows image,</span>
      <span class="no"># and uses the CF-foundation dockerhub repo</span>
      <span class="no"># to pull the appropriate Microsoft-hosted foreign layer.</span>
      <span class="no">winfs-injector \</span>
      <span class="no">--input-tile &quot;$product_file&quot; \</span>
      <span class="no">--output-tile &quot;downloaded-product/${TILE_FILENAME}&quot;</span>
    <span class="no">else</span>
      <span class="no">cp &quot;$product_file&quot; downloaded-product</span>
    <span class="no">fi</span>

    <span class="no">if [ -e &quot;$stemcell_file&quot; ]; then</span>
      <span class="no">cp &quot;$stemcell_file&quot; downloaded-stemcell</span>
    <span class="no">fi</span>

    <span class="no">if [ -e downloaded-files/assign-stemcell.yml ]; then</span>
      <span class="no">cp downloaded-files/assign-stemcell.yml assign-stemcell-config/config.yml</span>
    <span class="no">fi</span>
</pre></div>
</td></tr></table>

<h3 id="download-product-s3">download-product-s3</h3>
<p>Downloads a product specified in a config file from an S3-compatible blobstore.
This is useful when retrieving assets in an offline environment.</p>
<p>Downloads are cached, so files are not re-downloaded each time.</p>
<p>This is intended to be used with files downloaded from Pivnet by <a href="task.html#download-product"><code>download-product</code></a>
and then persisted to a blobstore using a <code>put</code> step.</p>
<p>Outputs can be used directly as an input to <a href="#upload-and-stage-product">upload-and-stage-product</a>
and <a href="#upload-stemcell">upload-stemcell</a> tasks.</p>
<p>This task requires a <a href="inputs-outputs.html#download-product-config">download-product config file</a>.
The same configuration file should be used with both this task and <a href="task.html#download-product"><code>download-product</code></a>.
This ensures that the same file
is being captured with both tasks. </p>
<p>The product files uploaded to s3 for download with this task require a specific prefix:
<code>[product-slug,semantic-version]</code>.
This prefix is added by the <a href="task.html#download-product"><code>download-product</code></a> task
when S3 keys are present in the configuration file.
This is the meta information about the product from Pivnet,
which is <em>not guaranteed</em> to be in the original filename.
This tasks uses the meta information to be able to perform 
consistent downloads from s3
as defined in the provided download config.
For example:</p>
<ul>
<li>
<p>original-pivnet-filenames:
  <table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">ops</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="n">aws</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="n">build</span><span class="p">.</span><span class="mi">123</span><span class="p">.</span><span class="n">yml</span>
<span class="n">cf</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="n">build</span><span class="p">.</span><span class="mi">45</span><span class="p">.</span><span class="n">pivotal</span>
</pre></div>
</td></tr></table></p>
</li>
<li>
<p>filenames expected by <code>download-product-s3</code> in a bucket:
  <table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span><span class="n">ops</span><span class="o">-</span><span class="n">manager</span><span class="p">,</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="p">]</span><span class="n">ops</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="n">aws</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="n">build</span><span class="p">.</span><span class="mi">123</span><span class="p">.</span><span class="n">yml</span>
<span class="p">[</span><span class="n">elastic</span><span class="o">-</span><span class="n">runtime</span><span class="p">,</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="p">]</span><span class="n">cf</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="n">build</span><span class="p">.</span><span class="mi">45</span><span class="p">.</span><span class="n">pivotal</span>
</pre></div>
</td></tr></table></p>
</li>
</ul>
<div class="admonition info">
<p class="admonition-title">When only downloading from Pivnet</p>
<p>When the download product config only has Pivnet credentials,
it will not add the prefix to the downloaded product.
For example, <code>example-product.pivotal</code> from Pivnet will be outputed
as <code>example-product.pivotal</code>.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>It's possible to use IAM instance credentials
instead of providing S3 creds in the config file.
See <a href="inputs-outputs.html#download-product-config">download-product config file</a> for details.</p>
</div>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span> <span class="c1"># contains download-file config file</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vars</span> <span class="c1"># variable files to be made available</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">secrets</span>
  <span class="c1"># secret files to be made available</span>
  <span class="c1"># separate from vars, so they can be store securely</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">outputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">downloaded-product</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">downloaded-stemcell</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">assign-stemcell-config</span>

<span class="nt">caches</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">downloaded-files</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">download-config.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath to the product configuration yaml file</span>
  <span class="c1"># - The path is relative to the root of the `config` input</span>

  <span class="nt">VARS_FILES</span><span class="p">:</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - Filepath to the product configuration vars yaml file</span>
  <span class="c1"># - The path is relative to root of the task build,</span>
  <span class="c1">#   so `vars` and `secrets` can be used.</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>

    <span class="no">vars_files_args=(&quot;&quot;)</span>
    <span class="no">for vf in ${VARS_FILES}</span>
    <span class="no">do</span>
      <span class="no">vars_files_args+=(&quot;--vars-file ${vf}&quot;)</span>
    <span class="no">done</span>

    <span class="no"># ${vars_files_args[@] needs to be globbed to pass through properly</span>
    <span class="no"># shellcheck disable=SC2068</span>
    <span class="no">om download-product \</span>
       <span class="no">--config config/&quot;${CONFIG_FILE}&quot; ${vars_files_args[@]} \</span>
       <span class="no">--output-directory downloaded-files \</span>
       <span class="no">--source s3</span>

    <span class="no">product_file=$(om interpolate \</span>
    <span class="no">--config downloaded-files/download-file.json \</span>
    <span class="no">--path /product_path)</span>

    <span class="no">stemcell_file=$(om interpolate \</span>
      <span class="no">--config downloaded-files/download-file.json \</span>
      <span class="no">--path /stemcell_path?)</span>

    <span class="no">cp &quot;$product_file&quot; downloaded-product</span>

    <span class="no">if [ -e &quot;$stemcell_file&quot; ]; then</span>
      <span class="no">cp &quot;$stemcell_file&quot; downloaded-stemcell</span>
    <span class="no">fi</span>

    <span class="no">if [ -e downloaded-files/assign-stemcell.yml ]; then</span>
      <span class="no">cp downloaded-files/assign-stemcell.yml assign-stemcell-config/config.yml</span>
    <span class="no">fi</span>
</pre></div>
</td></tr></table>

<h3 id="export-installation">export-installation</h3>
<p>Exports an existing Ops Manager to a file.</p>
<p>This is the first part of the backup/restore and upgrade lifecycle processes.
This task is used on a fully installed and healthy Ops Manager to export
settings to an upgraded version of Ops Manager.</p>
<p>To use with non-versioned blobstore, you can override <code>INSTALLATION_FILE</code> param
to include <code>$timestamp</code>, then the generated installation file will include a sortable
timestamp in the filename.</p>
<p>example:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">params</span><span class="p">:</span>
  <span class="nt">INSTALLATION_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation-$timestamp.zip</span>
</pre></div>
</td></tr></table></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The timestamp is generated using the time on concourse worker.
If the time is different on different workers, the generated timestamp may fail to sort correctly.
Changing the time or timezone on workers might interfere with ordering.</p>
</div>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>

<span class="nt">outputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation</span> <span class="c1"># will contain the exported installation</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

  <span class="nt">INSTALLATION_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation-$timestamp.zip</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the installation ZIP file</span>
  <span class="c1"># - The path is relative to root of the `installation` output</span>
  <span class="c1"># - if the filename includes &quot;$timestamp&quot;,</span>
  <span class="c1">#   for example &quot;installation-$timestamp.zip&quot;,</span>
  <span class="c1">#   the final filename will include the current timestamp.</span>
  <span class="c1">#   - this is necessary if using an &quot;S3 compatible&quot; blobstore</span>
  <span class="c1">#     that doesn&#39;t support versioned blobs</span>
  <span class="c1">#   - timestamped filenames will need to be represented</span>
  <span class="c1">#     with a glob-style wildcard in the `upgrade-opsman` task configuration</span>
  <span class="c1">#     (the default will work with the example provided above).</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">-c</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>

    <span class="no">timestamp=&quot;$(date &#39;+%Y%m%d.%-H%M.%S+%Z&#39;)&quot;</span>
    <span class="no">export timestamp</span>

    <span class="no"># &#39;$timestamp&#39; must be a literal, because envsubst uses it as a filter</span>
    <span class="no"># this allows us to avoid accidentally interpolating anything else.</span>
    <span class="no"># shellcheck disable=SC2016</span>
    <span class="no">OUTPUT_FILE_NAME=&quot;$(echo &quot;$INSTALLATION_FILE&quot; | envsubst &#39;$timestamp&#39;)&quot;</span>

    <span class="no">om --env env/&quot;${ENV_FILE}&quot; export-installation \</span>
       <span class="no">--output-file installation/&quot;$OUTPUT_FILE_NAME&quot;</span>
</pre></div>
</td></tr></table>

<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is recommended to persist the zip file exported from export-installation
 to an external file store (eg S3) on a regular basis.
 The exported installation can restore the Ops Manager
 to a working state if it is non-functional.</p>
</div>
<h3 id="import-installation">import-installation</h3>
<p>Imports a previously exported installation to Ops Manager.</p>
<p>This is a part of the backup/restore and upgrade lifecycle processes.
This task is used after an installation has been exported and a new Ops Manager
has been deployed, but before the new Ops Manager is configured.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the environment information about the OpsMan</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation</span> <span class="c1"># contains the installation to be imported</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the environment config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>
  <span class="c1"># - The env file _must_ contain the `decryption-passphrase`</span>
  <span class="c1">#   while it&#39;s optional for other tasks, this one requires it.</span>

  <span class="nt">INSTALLATION_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation*.zip</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the installation ZIP file</span>
  <span class="c1"># - The filepath provided can be wildcard expanded.</span>
  <span class="c1"># - The path is relative to root of the `installation` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">-c</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>

    <span class="no"># INSTALLATION_FILE needs to be globbed</span>
    <span class="no"># shellcheck disable=SC2086</span>
    <span class="no">om --env env/&quot;${ENV_FILE}&quot; import-installation \</span>
       <span class="no">--installation installation/$INSTALLATION_FILE</span>
</pre></div>
</td></tr></table>

<h3 id="make-git-commit">make-git-commit</h3>
<p>Copies a single file into a repo and makes a commit.
Useful for persisting the state output of tasks that manage the vm, such as:</p>
<ul>
<li><a href="#create-vm">create-vm</a></li>
<li><a href="#upgrade-opsman">upgrade-opsman</a></li>
<li><a href="#delete-vm">delete-vm</a></li>
</ul>
<p>Also useful for persisting the configuration output from:</p>
<ul>
<li><a href="#staged-config">staged-config</a></li>
<li><a href="#staged-director-config">staged-director-config</a></li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>This commits <strong>all changes</strong> present
in the repo used for the <code>repository</code> input,
in addition to copying in a single file.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>This does not perform a <code>git push</code>!
You will need to <code>put</code> the output of this task to a git resource to persist it.</p>
</div>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">repository</span>
  <span class="c1"># - This must be an initialized git repository.</span>
  <span class="c1"># - Note that any changes present in this input</span>
  <span class="c1">#   will be committed along with the file copied in</span>
  <span class="c1">#   by this task.</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">file-source</span>
  <span class="c1"># - This is the input folder containing the file to be committed.</span>
  <span class="c1">#   Typically, this will from some other task</span>
  <span class="c1">#   with an output that needs to be persisted.</span>
<span class="nt">outputs</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">repository-commit</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">FILE_SOURCE_PATH</span><span class="p">:</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath to be copied into the git repo</span>
  <span class="c1">#   before a commit is created</span>
  <span class="c1"># - Relative to the root of the `file-source` input</span>

  <span class="nt">FILE_DESTINATION_PATH</span><span class="p">:</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath to write the file specified by FILE_SOURCE_PATH</span>
  <span class="c1"># - Relative to the root of the `repository` input</span>

  <span class="nt">GIT_AUTHOR_NAME</span><span class="p">:</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Used to configure the human-readable</span>
  <span class="c1">#   name in the `author` field of the commit</span>

  <span class="nt">GIT_AUTHOR_EMAIL</span><span class="p">:</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Used to configure the email address</span>
  <span class="c1">#   in the `author` field of the commit</span>

  <span class="nt">COMMIT_MESSAGE</span><span class="p">:</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Specify a commit message to be used</span>
  <span class="c1">#   for all commits made by this task.</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
    <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
      <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
      <span class="no">set -eu</span>
      <span class="no">git config --global user.email &quot;$GIT_AUTHOR_EMAIL&quot;</span>
      <span class="no">git config --global user.name &quot;$GIT_AUTHOR_NAME&quot;</span>

      <span class="no">git clone repository repository-commit</span>

      <span class="no">if [ ! -d &quot;$(dirname &quot;$FILE_DESTINATION_PATH&quot;)&quot; ]; then</span>
        <span class="no">echo &quot;Directory $(dirname &quot;$FILE_DESTINATION_PATH&quot;) does not exist in repository, creating it...&quot;</span>
        <span class="no">mkdir -p &quot;$(dirname &quot;$FILE_DESTINATION_PATH&quot;)&quot;;</span>
      <span class="no">fi;</span>

      <span class="no">cp file-source/&quot;$FILE_SOURCE_PATH&quot; \</span>
         <span class="no">repository-commit/&quot;$FILE_DESTINATION_PATH&quot;</span>
      <span class="no">cd repository-commit</span>
      <span class="no">git add -A</span>
      <span class="no">git commit -m &quot;$COMMIT_MESSAGE&quot; --allow-empty</span>
</pre></div>
</td></tr></table>

<h3 id="pre-deploy-check">pre-deploy-check</h3>
<p>Checks if the Ops Manager director is configured properly and validates the configuration.
Additionally, checks each of the staged products
and validates they are configured correctly.
This task can be run at any time
and can be used a a pre-check for <a href="task.html#apply-changes"><code>apply-changes</code></a>.</p>
<p>The checks that this task executes are:</p>
<ul>
<li>is configuration complete and valid</li>
<li>is the network assigned</li>
<li>is the availability zone assigned</li>
<li>is the stemcell assigned</li>
<li>what stemcell type/version is required</li>
<li>are there any unset/invalid properties</li>
<li>did any ops manager verifiers fail</li>
</ul>
<p>If any of the above checks fail
the task will fail. 
The failed task will provide a list of errors that need to be fixed 
before an <code>apply-changes</code> could start. </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>

    <span class="no">om --env env/&quot;${ENV_FILE}&quot; pre-deploy-check</span>
</pre></div>
</td></tr></table>

<h3 id="stage-product">stage-product</h3>
<p>Staged a product to the Ops Manager specified in the config file.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">product</span> <span class="c1"># contains the product file to be uploaded and staged</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>

    <span class="no">product_name=&quot;$(om tile-metadata \</span>
      <span class="no">--product-path product/*.pivotal \</span>
      <span class="no">--product-name)&quot;</span>
    <span class="no">product_version=&quot;$(om tile-metadata \</span>
      <span class="no">--product-path product/*.pivotal \</span>
      <span class="no">--product-version)&quot;</span>

    <span class="no">om --env env/&quot;${ENV_FILE}&quot; stage-product \</span>
       <span class="no">--product-name &quot;$product_name&quot; \</span>
       <span class="no">--product-version &quot;$product_version&quot;</span>
</pre></div>
</td></tr></table>

<h3 id="staged-config">staged-config</h3>
<p>Downloads the configuration for a product from Ops Manager.</p>
<p>Not to be confused with Ops Manager's
built-in <a href="https://docs.pivotal.io/pivotalcf/2-1/customizing/backup-restore/backup-pcf-bbr.html#export">export</a>,
which puts all deployed products and configurations into a single file,
intended for import as part of backup/restore and upgrade lifecycle processes.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>

<span class="nt">outputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">generated-config</span> <span class="c1"># will contain the staged product config</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">PRODUCT_NAME</span><span class="p">:</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - The name of the product config to be exported</span>

  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

  <span class="nt">SUBSTITUTE_CREDENTIALS_WITH_PLACEHOLDERS</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - Replace credentials with interpolatable variable names</span>
  <span class="c1"># - If set to false, **literal credentials** will be included in the output</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>

    <span class="no">flag=$(if &quot;$SUBSTITUTE_CREDENTIALS_WITH_PLACEHOLDERS&quot;;</span>
           <span class="no">then echo &#39;--include-placeholders&#39;;</span>
           <span class="no">else echo &#39;--include-credentials&#39;;</span>
           <span class="no">fi</span>
          <span class="no">)</span>

    <span class="no">om --env env/&quot;${ENV_FILE}&quot; staged-config \</span>
       <span class="no">--product-name &quot;$PRODUCT_NAME&quot; \</span>
       <span class="no">&quot;$flag&quot; &gt; generated-config/&quot;$PRODUCT_NAME&quot;.yml</span>
</pre></div>
</td></tr></table>

<h3 id="staged-director-config">staged-director-config</h3>
<div class="admonition warning">
<p class="admonition-title">Ops Manager 2.5</p>
<p>The filename for the artifact downloaded from Ops Manager is changed! If your resources or pipelines
 have a regex for the Ops Manager filename, you <strong>may</strong> be affected. (Please see
 Ops Manager's <a href="https://community.pivotal.io/s/article/ops-manager-2-5-changing-the-file-naming-scheme-might-break-the-pipeline-jobs">official notice</a>
 for more information)</p>
</div>
<p>Downloads configuration for the BOSH director from Ops Manager.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>

<span class="nt">outputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">generated-config</span> <span class="c1"># will contain the staged product config</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">-c</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>
    <span class="no">om --env env/&quot;${ENV_FILE}&quot; staged-director-config \</span>
       <span class="no">--include-placeholders &gt; generated-config/director.yml</span>
</pre></div>
</td></tr></table>

<p>The configuration is exported to the <code>generated-config</code> output.
It does not extract credentials from Ops Manager
and replaced them all with YAML interpolation <code>(())</code> placeholders.
This is to ensure that credentials are never written to disk.
The credentials need to be provided from an external configuration when invoking <a href="#configure-director">configure-director</a>.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>staged-director-config will not be able to grab all sensitive fields in your Ops Manager installation
(for example: vcenter_username and vcenter_password if using vsphere). To find these missing fields, please refer to the <a href="https://docs.pivotal.io/pivotalcf/opsman-api/">Ops Manager API Documentation</a></p>
</div>
<h3 id="test">test</h3>
<p>An example task to ensure the assets and docker image are setup correctly in your concourse pipeline.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">echo &quot;Platform Automation for PCF version:&quot;</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>

    <span class="no">printf &quot;\\np-automator version:&quot;</span>
    <span class="no">p-automator -v</span>

    <span class="no">printf &quot;\\nom version:&quot;</span>
    <span class="no">om -v</span>

    <span class="no">set -eux</span>
    <span class="no">p-automator --help</span>
    <span class="no">om --help</span>
    <span class="no">{ echo &quot;Successfully validated tasks and image!&quot;; } 2&gt; /dev/null</span>
</pre></div>
</td></tr></table>

<h3 id="test-interpolate">test-interpolate</h3>
<p>An example task to ensure that all required vars are present when interpolating into a base file.
For more instruction on this topic, see the <a href="../pipeline-design/variables.html">variables</a> section</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span> <span class="c1"># contains the base configuration file</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vars</span> <span class="c1"># variable files to be made available</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">VARS_FILES</span><span class="p">:</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - Filepath to the vars yaml file</span>
  <span class="c1"># - The path is relative to root of the task build,</span>
  <span class="c1">#   so `vars` and `secrets` can be used.</span>

  <span class="nt">CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">base.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath to the base yaml file to interpolate from</span>
  <span class="c1"># - The path is relative to root of the task build</span>

  <span class="nt">SKIP_MISSING</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - Change to false to have strict interpolation</span>
  <span class="c1">#   and fail if params are missing from vars</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>

    <span class="no">vars_files_args=(&quot;&quot;)</span>
    <span class="no">for vf in ${VARS_FILES}</span>
    <span class="no">do</span>
      <span class="no">vars_files_args+=(&quot;--vars-file ${vf}&quot;)</span>
    <span class="no">done</span>

    <span class="no">if [ &quot;$SKIP_MISSING&quot; ]; then</span>
      <span class="no">export SKIP_MISSING=&quot;--skip-missing&quot;</span>
    <span class="no">else</span>
      <span class="no">export SKIP_MISSING=&quot;&quot;</span>
    <span class="no">fi</span>

    <span class="no"># ${vars_files_args[@] needs to be globbed to pass through properly</span>
    <span class="no"># shellcheck disable=SC2068</span>
    <span class="no">om interpolate --config &quot;config/$CONFIG_FILE&quot; &quot;$SKIP_MISSING&quot; ${vars_files_args[@]}</span>
</pre></div>
</td></tr></table>

<h3 id="upgrade-opsman">upgrade-opsman</h3>
<p>Upgrades an existing Ops Manager to a new given Ops Manager version</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">state</span> <span class="c1"># contains the state for the vm</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span> <span class="c1"># contains the OpsMan configuration file</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">image</span> <span class="c1"># contains the image file to be installed</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation</span> <span class="c1"># contains the installation to be imported</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the environment information for OpsMan</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vars</span> <span class="c1"># variable files to be made available</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">secrets</span> <span class="c1"># secret files to be made available</span>
  <span class="c1"># separate from vars, so they can be stored securely</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">outputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">generated-state</span> <span class="c1">#contains the updated state file</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">VARS_FILES</span><span class="p">:</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - space-seperated array of filepaths to YAML vars files</span>
  <span class="c1">#   to be loaded with the OPSMAN_CONFIG_FILE</span>
  <span class="c1"># - relative to root of the task build,</span>
  <span class="c1">#   so both `vars` and `secrets` can be used.</span>

  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - filepath of the env config YAML</span>
  <span class="c1"># - relative to root of the `env` input</span>

  <span class="nt">OPSMAN_CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">opsman.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - filepath of the opsman config YAML</span>
  <span class="c1"># - relative to root of the `config` input</span>

  <span class="nt">STATE_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">state.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - filepath of the state YAML file</span>
  <span class="c1"># - relative to root of the `state` input</span>

  <span class="nt">INSTALLATION_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation*.zip</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - filepath of the installation ZIP file</span>
  <span class="c1"># - can be wildcard expanded</span>
  <span class="c1"># - relative to root of the `installation` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">p-automator -v</span>
    <span class="no">set -eux</span>

    <span class="no">vars_files_args=(&quot;&quot;)</span>
    <span class="no">for vf in ${VARS_FILES}</span>
    <span class="no">do</span>
      <span class="no">vars_files_args+=(&quot;--vars-file ${vf}&quot;)</span>
    <span class="no">done</span>

    <span class="no">generated_state_path=&quot;generated-state/$(basename &quot;$STATE_FILE&quot;)&quot;</span>
    <span class="no">cp &quot;state/$STATE_FILE&quot; &quot;$generated_state_path&quot;</span>

    <span class="no"># ${vars_files_args[@] needs to be globbed to split properly (SC2068)</span>
    <span class="no"># INSTALLATION_FILE needs to be globbed (SC2086)</span>
    <span class="no"># shellcheck disable=SC2068,SC2086</span>
    <span class="no">p-automator upgrade-opsman \</span>
    <span class="no">--config config/&quot;${OPSMAN_CONFIG_FILE}&quot; \</span>
    <span class="no">--env-file env/&quot;${ENV_FILE}&quot; \</span>
    <span class="no">--image-file &quot;$(find image/*.{yml,ova,raw} | head -n1)&quot;  \</span>
    <span class="no">--state-file &quot;$generated_state_path&quot; \</span>
    <span class="no">--installation installation/$INSTALLATION_FILE \</span>
    <span class="no">${vars_files_args[@]}</span>
</pre></div>
</td></tr></table>

<p>For more information about this task and how it works, see the <a href="../upgrade.html">upgrade</a> page.</p>
<h3 id="upload-and-stage-product">upload-and-stage-product</h3>
<p>Uploads and stages product to the Ops Manager specified in the config file.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">product</span> <span class="c1"># contains the product file to be uploaded and staged</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span> <span class="c1"># contains the product configuration file</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">CONFIG_FILE</span><span class="p">:</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - Path to the config file for the product</span>
  <span class="c1"># - Relative to the root of the config input</span>
  <span class="c1"># - If empty, no config will be used; version and sha256 will not be checked</span>
  <span class="c1"># - Example config:</span>
  <span class="c1"># ---</span>
  <span class="c1"># product-version: 1.2.3-build.4</span>
  <span class="c1"># sha256: 6daededd8fb4c341d0cd437a669d732d2fde62cb89716498e6b16f34607a1498</span>

  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>

    <span class="no">if [ -z &quot;$CONFIG_FILE&quot; ]; then</span>
        <span class="no">om --env env/&quot;${ENV_FILE}&quot; upload-product \</span>
           <span class="no">--product product/*.pivotal</span>
    <span class="no">else</span>
      <span class="no">om --env env/&quot;${ENV_FILE}&quot; upload-product \</span>
         <span class="no">--product product/*.pivotal --config &quot;config/$CONFIG_FILE&quot;</span>
    <span class="no">fi</span>

    <span class="no">product_name=&quot;$(om tile-metadata \</span>
      <span class="no">--product-path product/*.pivotal \</span>
      <span class="no">--product-name)&quot;</span>
    <span class="no">product_version=&quot;$(om tile-metadata \</span>
      <span class="no">--product-path product/*.pivotal \</span>
      <span class="no">--product-version)&quot;</span>

    <span class="no">om --env env/&quot;${ENV_FILE}&quot; stage-product \</span>
       <span class="no">--product-name &quot;$product_name&quot; \</span>
       <span class="no">--product-version &quot;$product_version&quot;</span>
</pre></div>
</td></tr></table>

<h3 id="upload-product">upload-product</h3>
<p>Uploads a product to the Ops Manager specified in the config file.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">product</span> <span class="c1"># contains the product file to be uploaded and staged</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span> <span class="c1"># contains the product configuration file</span>
  <span class="nt">optional</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">CONFIG_FILE</span><span class="p">:</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - Path to the config file for the product</span>
  <span class="c1"># - Relative to the root of the `config` input</span>
  <span class="c1"># - If empty, no config will be used; version and sha256 will not be checked</span>
  <span class="c1"># - Example config:</span>
  <span class="c1"># ---</span>
  <span class="c1"># product-version: 1.2.3-build.4</span>
  <span class="c1"># shasum: 6daededd8fb4c341d0cd437a669d732d2fde62cb89716498e6b16f34607a1498</span>
  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - Relative to root of the `env` input</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>

    <span class="no">export OPTIONAL_CONFIG_FLAG=&quot;&quot;</span>
    <span class="no">if [ -n &quot;$CONFIG_FILE&quot; ]; then</span>
      <span class="no">export OPTIONAL_CONFIG_FLAG=&quot;--config config/$CONFIG_FILE&quot;</span>
    <span class="no">fi</span>
    <span class="no">om --env env/&quot;${ENV_FILE}&quot; upload-product \</span>
       <span class="no">--product product/*.pivotal \</span>
       <span class="no">&quot;$OPTIONAL_CONFIG_FLAG&quot;</span>
</pre></div>
</td></tr></table>

<h3 id="upload-stemcell">upload-stemcell</h3>
<p>Uploads a stemcell to Ops Manager.</p>
<p>Note that the filename of the stemcell must be exactly as downloaded from Pivnet.
Ops Manager parses this filename to determine the version and OS of the stemcell.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>

<span class="nt">inputs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env</span> <span class="c1"># contains the env file with target OpsMan Information</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stemcell</span> <span class="c1"># contains the stemcell tarball</span>
<span class="c1"># - The stemcell filename is important and must be preserved.</span>
<span class="c1">#   if using the bosh.io concourse resource,</span>
<span class="c1">#   set `params.preserve_filename: true` on your GET.</span>

<span class="nt">params</span><span class="p">:</span>
  <span class="nt">CONFIG_FILE</span><span class="p">:</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - Path to the config file for the product</span>
  <span class="c1"># - Relative to the root of the `config` input</span>
  <span class="c1"># - If empty, no config will be used; version and sha256 will not be checked</span>
  <span class="c1"># - Example config:</span>
  <span class="c1"># ---</span>
  <span class="c1"># shasum: 6daededd8fb4c341d0cd437a669d732d2fde62cb89716498e6b16f34607a1498</span>

  <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">env.yml</span>
  <span class="c1"># - Required</span>
  <span class="c1"># - Filepath of the env config YAML</span>
  <span class="c1"># - The path is relative to root of the `env` input</span>

  <span class="nt">FLOATING_STEMCELL</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="c1"># - Optional</span>
  <span class="c1"># - Assigns the stemcell to all compatible products</span>
  <span class="c1"># - If false, a user is required to run the assign-stemcell task</span>

<span class="nt">run</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bash</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
    <span class="no">cat /var/version &amp;&amp; echo &quot;&quot;</span>
    <span class="no">set -eux</span>

    <span class="no">export OPTIONAL_CONFIG_FLAG=&quot;&quot;</span>
    <span class="no">if [ -n &quot;$CONFIG_FILE&quot; ]; then</span>
      <span class="no">export OPTIONAL_CONFIG_FLAG=&quot;--config config/$CONFIG_FILE&quot;</span>
    <span class="no">fi</span>
    <span class="no">om --env env/&quot;${ENV_FILE}&quot; upload-stemcell \</span>
       <span class="no">--floating=&quot;$FLOATING_STEMCELL&quot; \</span>
       <span class="no">--stemcell &quot;$PWD&quot;/stemcell/*.tgz \</span>
       <span class="no">&quot;$OPTIONAL_CONFIG_FLAG&quot;</span>
</pre></div>
</td></tr></table></article></div></div></main><!-- Application footer -->
<footer class="md-footer">

    <!-- Link to previous and/or next page --><div class="md-footer-nav">
        <nav class="md-footer-nav__inner md-grid">

            <!-- Link to previous page --><a href="../how-to-guides/install-opsman.html"
               title="Installing Ops Manager"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
                <div class="md-flex__cell md-flex__cell--shrink">
                    <i class="md-icon md-icon--arrow-back
                    md-footer-nav__button"></i>
                </div>
                <div class="md-flex__cell md-flex__cell--stretch
                  md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">Previous</span>Installing Ops Manager</span>
                </div>
            </a><!-- Link to next page --><a href="inputs-outputs.html"
               title="Inputs/Outputs"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
                <div class="md-flex__cell md-flex__cell--stretch
                  md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">Next</span>Inputs/Outputs</span>
                </div>
                <div class="md-flex__cell md-flex__cell--shrink">
                    <i class="md-icon md-icon--arrow-forward
                    md-footer-nav__button"></i>
                </div>
            </a></nav>
    </div><!-- Further information -->
    <div class="md-footer-meta md-typeset">
        <div class="md-footer-meta__inner md-grid">

            <!-- Copyright and theme information -->
            <div class="md-footer-copyright">
                <a href="https://pivotal.io/privacy-policy">
                    Privacy Policy
                </a>
                |
                <a href="https://pivotal.io/legal/">
                    Terms of Use
                </a>
            </div>

            <div class="md-footer-social">
                <a href="https://pivotal.io">
                    Pivotal Documentation © 2019 Pivotal Software, Inc. All Rights Reserved
                </a>
            </div>

        </div>
    </div>
</footer></div><script src="../assets/javascripts/application.b260a35d.js"></script><script>app.initialize({version:"1.0.4",url:{base:".."}})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/7.1.2/mermaid.min.js"></script></body></html>