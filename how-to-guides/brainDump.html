<!doctype html><html lang="en" class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="x-ua-compatible" content="ie=edge"><link rel="canonical" href="https://docs.pivotal.io/how-to-guides/brainDump.html"><meta name="lang:clipboard.copy" content="Copy to clipboard"><meta name="lang:clipboard.copied" content="Copied to clipboard"><meta name="lang:search.language" content="en"><meta name="lang:search.pipeline.stopwords" content="True"><meta name="lang:search.pipeline.trimmer" content="True"><meta name="lang:search.result.none" content="No matching documents"><meta name="lang:search.result.one" content="1 matching document"><meta name="lang:search.result.other" content="# matching documents"><meta name="lang:search.tokenizer" content="[\s\-]+"><link rel="shortcut icon" href="../assets/icon.svg"><meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.3.0"><title>How to: Upgrade an Existing Ops Manager - Platform Automation</title><link rel="stylesheet" href="../assets/stylesheets/application.4031d38b.css"><link rel="stylesheet" href="../assets/stylesheets/application-palette.224b79ff.css"><meta name="theme-color" content="#009688"><script src="../assets/javascripts/modernizr.74668098.js"></script><link href="https://fonts.gstatic.com" rel="preconnect" crossorigin><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700|Ubuntu+Mono&display=swap"><style>body,input{font-family:"Source Sans Pro","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style><link rel="stylesheet" href="../assets/fonts/material-icons.css">
<style>
label.md-nav__link {
    font-weight: bold;
}

@media only screen and (min-width: 76.1875em) {
  label.md-nav__title.md-nav__title--site {
      display: none;
  }
}
.header-dropdown {
  display: inline-block;
  position: relative;
  margin-left: 10px;
  cursor: pointer;
}

.header-dropdown:hover .content,
.header-dropdown:hover .content:hover {
  display: block;
  visibility: visible;
  opacity: 1;
}

.header-dropdown .content {
  position: absolute;
  top: 100%;
  background-color: #009688;
  left: 0;
  display: none;
  z-index: 1;
  clear: both;
  padding: 10px;
}

.header-dropdown ul {
  padding: 0;
  margin: 0;
  line-height: 24px;
}

.header-dropdown ul li {
  list-style: none;
}

.md-header-nav__topic {
  overflow: visible;
}

.header-dropdown .pointer {
  height: 24px;
  width: 24px;
  display: inline-flex;
  vertical-align: middle;
  fill: white;
}

.md-typeset pre, .md-typeset code {
  font-size: 100%
}

.md-typeset table:not([class]) {
  font-size: 16px
}

.md-typeset > .codehilitetable {
  overflow: visible;
}

.md-typeset .md-footer-social {
    font-size: .64rem;
}

.md-footer-social {
    padding: .4rem 0;
}
</style>


</head><body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal"><svg class="md-svg"><defs><svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg></defs></svg> <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off"> <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off"> <label class="md-overlay" data-md-component="overlay" for="__drawer"></label><a href="#how-to-upgrade-an-existing-ops-manager" tabindex="1" class="md-skip">Skip to content </a><style>
    .header-dropdown {
        font-size: .75em;
    }

    .header-dropdown .content {
        top: 97%;
    }

    @media only screen and (max-width: 60em) {
        .md-header .secondary-header {
            display: none;
        }
    }
    @media only screen and (min-width: 60em) {
        .md-header {
            height: 7.4rem;
        }

        .md-header .md-header-nav {
            height: 5rem;
        }

        .md-header .md-header-nav .md-flex {
            height: 100%;
        }

        .md-header .md-header-nav .md-flex__cell {
            vertical-align: middle;
        }

        .md-header .md-header-nav .md-header-nav__title {
            font-size: 1.25rem;
            line-height: 5rem;
        }

        .md-header .secondary-header .md-flex__cell {
            width: 30rem;
            text-align: right;
        }

        .md-header .secondary-header .md-grid {
            padding: 0 .6rem;
        }

        .md-header .secondary-header .logo {
            text-align: left;
        }

        .md-header .secondary-header {
            height: 2.4rem;
            line-height: 3.0rem;
            background-color: #243640;
        }

        .md-header .secondary-header .sub {
            font-size: 13px;
        }

        .md-header .secondary-header .sub a {
            margin-right: 17px;
        }

        .global-header-title .pivotal-logo {
            fill: white;
            height: .9rem;
            margin-right: 8px;
        }

        .global-header-title .documentation-letters {
            fill: white;
            height: .6rem;
        }

        .md-sidebar[data-md-state=lock] {
            top: 7.4rem;
        }

        .md-main__inner {
            padding-top: 5rem;
        }
    }
</style>
<header class="md-header" data-md-component="header">
    <div class="secondary-header">
        <div class="md-flex md-grid">
            <div class="md-flex__cell logo">
            <a href="https://docs.pivotal.io" class="global-header-title" target="_blank">
            <svg class="pivotal-logo" xmlns="http://www.w3.org/2000/svg"
                 viewBox="0 0 174.72 40.94">
                <path class="a" d="M38.77,6h-6.2V0h6.2Zm0,34.24H32.56V10.41h6.22Z"></path>
                <path class="a"
                      d="M74.67,10.41,66,36.18c-1.49,4.22-4.15,4.76-6.3,4.76-3.19,0-5.11-1.47-6.24-4.75l-7.22-21.4H43.39V10.41h7.45l7.44,24c.33,1,.53,1.63,1.43,1.63s1.13-.62,1.43-1.63l7.59-24Z"></path>
                <path class="a"
                      d="M90,10.41c8.05,0,13.66,5.31,13.66,12.92V28c0,7.6-5.61,12.92-13.66,12.92S76.32,35.62,76.32,28V23.33c0-7.61,5.62-12.92,13.67-12.92M90,36c4.81,0,7.8-3.64,7.8-8V23.33c0-4.37-3-8-7.8-8-5.1,0-7.8,3.64-7.8,8V28c0,4.37,2.82,8,7.8,8"></path>
                <path class="a"
                      d="M153.32,11.36A53.46,53.46,0,0,0,141.8,10c-8.17,0-13.24,5.15-13.24,13.45v3.27c0,8.3,5.07,13.53,13.24,13.53.19,0,1.64,0,2.3-.06v-5l-2.3.07c-4.45,0-7.43-3.43-7.43-8.53V23.44c0-5.09,3-8.52,7.43-8.52a43.88,43.88,0,0,1,6.09.38l.33.08V40.24h6.22V12.4c0-.53,0-.74-1.13-1"></path>
                <rect class="a" x="160.44" width="6.22" height="40.24"></rect>
                <path class="a"
                      d="M10.92,0H0V40.24H6.47V5.59h3.79c.81,0,1.49,0,2.18.06,5.61.1,8.35,2.33,8.35,6.69,0,.17,0,.29,0,.47,0,4-2.21,6.71-8.32,6.71H10.67c0,1.55,0,4.41,0,5.41.63,0,1.22.06,1.82.06,8.78,0,15-3.45,15-12.11,0-.17,0-.35,0-.52C27.44,3.38,20.69,0,10.92,0"></path>
                <path class="a"
                      d="M114.7,4v6.43h10.13v4.82H114.7V32.61c0,2.73,1.74,2.8,4.26,2.8h5.87v4.83h-7.94c-5.87,0-8.48-2.35-8.48-7.63V4.84Z"></path>
                <path class="a"
                      d="M169.52,37.64a2.6,2.6,0,1,1,2.6,2.6A2.61,2.61,0,0,1,169.52,37.64Zm2.6-2.25a2.23,2.23,0,1,0,2.22,2.24A2.24,2.24,0,0,0,172.12,35.39ZM171.55,39h-.31V36.19h.8c.72,0,1.06.33,1.06.86a.82.82,0,0,1-.58.8l.74,1.17h-.36l-.68-1.1-.67,0Zm.51-1.34c.46,0,.75-.24.75-.62s-.25-.6-.79-.6h-.48V37.7Z"></path>
            </svg>
            <svg class="documentation-letters" xmlns="http://www.w3.org/2000/svg"
                 viewBox="0 0 358.62 30.84">
                <path class="a"
                      d="M3.71,37.26V7.45h9.52c9.25,0,15.06,6.75,15.06,14.92S22.48,37.26,13.23,37.26Zm21.9-14.89c0-7-4.47-12.6-12.38-12.6h-7V34.93h7C21.1,34.93,25.61,29.35,25.61,22.37Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a"
                      d="M33.52,22.37C33.52,13.66,39.24,7,48,7s14.48,6.7,14.48,15.41S56.72,37.79,48,37.79,33.52,31.09,33.52,22.37Zm26.28,0c0-7.55-4.64-13.09-11.8-13.09S36.21,14.82,36.21,22.37s4.6,13.1,11.79,13.1S59.8,29.88,59.8,22.37Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a"
                      d="M67.67,22.37C67.67,13.21,74.33,7,82.78,7a13.38,13.38,0,0,1,10.86,5.27L91.5,13.61a10.84,10.84,0,0,0-8.72-4.33c-7,0-12.42,5.32-12.42,13.09s5.45,13.1,12.42,13.1a10.82,10.82,0,0,0,8.72-4.34l2.19,1.34a13.51,13.51,0,0,1-10.91,5.32C74.33,37.79,67.67,31.54,67.67,22.37Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a"
                      d="M98.79,25.82V7.45h2.59V25.77c0,6,3.17,9.7,9,9.7s9-3.67,9-9.7V7.45H122V25.82c0,7.37-3.94,12-11.62,12S98.79,33.15,98.79,25.82Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a"
                      d="M154.75,37.26V10.66l-10.87,26.6h-1L132,10.66v26.6h-2.55V7.45h3.8l10.14,24.8,10.1-24.8h3.85V37.26Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a" d="M164.76,37.26V7.45h18.91V9.77H167.31v11h16v2.32h-16v11.8h16.36v2.33Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a" d="M211.29,37.26,192.52,11.65V37.26H190V7.45h2.59L211.25,32.7V7.45h2.54V37.26Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a" d="M228.81,37.26V9.77h-9.74V7.45h22.08V9.77h-9.74V37.26Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a"
                      d="M264.93,37.26,262,29.93H246.2l-2.95,7.33H240.3L252.51,7.45h3.17l12.2,29.81ZM254.11,10.17,247.05,27.6h14.08Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a" d="M276.78,37.26V9.77H267V7.45h22.07V9.77h-9.74V37.26Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a" d="M294.39,37.26V7.45h2.55V37.26Z" transform="translate(-3.71 -6.96)"></path>
                <path class="a"
                      d="M303.24,22.37C303.24,13.66,309,7,317.72,7s14.48,6.7,14.48,15.41-5.76,15.42-14.48,15.42S303.24,31.09,303.24,22.37Zm26.28,0c0-7.55-4.65-13.09-11.8-13.09s-11.8,5.54-11.8,13.09,4.61,13.1,11.8,13.1S329.52,29.88,329.52,22.37Z"
                      transform="translate(-3.71 -6.96)"></path>
                <path class="a" d="M359.83,37.26,341.06,11.65V37.26h-2.55V7.45h2.59L359.78,32.7V7.45h2.55V37.26Z"
                      transform="translate(-3.71 -6.96)"></path>
            </svg>
            </a></div>

            <div class="md-flex__cell sub">
                <a href="#">Support</a>
                <a href="#">Downloads</a>
            </div>
        </div>
    </div>
    <nav class="md-header-nav md-grid">
        <div class="md-flex">
            <div class="md-flex__cell md-flex__cell--shrink">
                <a href="https://docs.pivotal.io" title="Platform Automation"
                   class="md-header-nav__button md-logo">
                    
                        <img src="../assets/icon.svg" width="65" height="65">
                    
                </a>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
                <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch">
                <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
                    
                        
                            <span class="md-header-nav__topic">
                                Platform Automation
                                
                                    <span class="header-dropdown">
                                        <a href="testin/how-to-guides/brainDump.html">2.1</a>
                                        <span class="pointer">
                                            <svg width="100%" height="100%" viewBox="0 0 24 24" fit="" preserveAspectRatio="xMidYMid meet"
                                               focusable="false"><path d="M18 9H6l6 6 6-6z" fill-rule="evenodd"></path></svg>
                                        </span>
                                        <span class="content">
                                            <ul>
                                              
                                                  <li> <a href="testin/how-to-guides/brainDump.html">1.1</a></li>
                                              
                                                  <li> <a href="testin/how-to-guides/brainDump.html">2.1</a></li>
                                              
                                                  <li> <a href="testin/how-to-guides/brainDump.html">develop</a></li>
                                              
                                            </ul>
                                        </span>
                                    </span>
                                
                            </span>
                            <span class="md-header-nav__topic">
                                How to: Upgrade an Existing Ops Manager
                            </span>
                        
                    
                </div>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
                
                    
                        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
                        <div class="md-search" data-md-component="search" role="dialog"><label class="md-search__overlay" for="__search"></label><div class="md-search__inner" role="search"><form class="md-search__form" name="search"><input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active"> <label class="md-icon md-search__icon" for="__search"></label> <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button></form><div class="md-search__output"><div class="md-search__scrollwrap" data-md-scrollfix><div class="md-search-result" data-md-component="result"><div class="md-search-result__meta">Type to start searching</div><ol class="md-search-result__list"></ol></div></div></div></div></div>
                    
                
            </div>
            
                <div class="md-flex__cell md-flex__cell--shrink">
                    <div class="md-header-nav__source">
                        <a href="https://github.com/pivotal/docs-platform-automation/" title="Go to repository" class="md-source" data-md-source="github"><div class="md-source__icon"><svg viewBox="0 0 24 24" width="24" height="24"><use xlink:href="#__github" width="24" height="24"></use></svg></div><div class="md-source__repository">Help fix the docs!</div></a>
                    </div>
                </div>
            
        </div>
    </nav>
</header><div class="md-container"><main class="md-main"><div class="md-main__inner md-grid" data-md-component="container"><div class="md-sidebar md-sidebar--primary" data-md-component="navigation"><div class="md-sidebar__scrollwrap"><div class="md-sidebar__inner"><nav class="md-nav md-nav--primary" data-md-level="0"><label class="md-nav__title md-nav__title--site" for="__drawer"><a href="https://docs.pivotal.io" title="Platform Automation" class="md-nav__button md-logo"><img src="../assets/icon.svg" width="48" height="48"></a>Platform Automation</label><div class="md-nav__source"><a href="https://github.com/pivotal/docs-platform-automation/" title="Go to repository" class="md-source" data-md-source="github"><div class="md-source__icon"><svg viewBox="0 0 24 24" width="24" height="24"><use xlink:href="#__github" width="24" height="24"></use></svg></div><div class="md-source__repository">Help fix the docs!</div></a></div><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../index.html" title="Introduction" class="md-nav__link">Introduction</a></li><li class="md-nav__item"><a href="../downloading-and-testing.html" title="Downloading and Testing" class="md-nav__link">Downloading and Testing</a></li><li class="md-nav__item"><a href="../compatibility-and-versioning.html" title="Compatibility and Versioning" class="md-nav__link">Compatibility and Versioning</a></li><li class="md-nav__item"><a href="../release-notes.html" title="Release Notes" class="md-nav__link">Release Notes</a></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5"><label class="md-nav__link" for="nav-5">Reference Pipelines</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-5">Reference Pipelines</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../pipeline/resources.html" title="Retrieving External Dependencies" class="md-nav__link">Retrieving External Dependencies</a></li><li class="md-nav__item"><a href="../pipeline/multiple-products.html" title="Ops Manager + multiple products" class="md-nav__link">Ops Manager + multiple products</a></li><li class="md-nav__item"><a href="../pipeline/single-product.html" title="Ops Manager + a product" class="md-nav__link">Ops Manager + a product</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6"><label class="md-nav__link" for="nav-6">Before You Begin</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-6">Before You Begin</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../before-you-begin/git-repo-layout.html" title="Git Repository Layout" class="md-nav__link">Git Repository Layout</a></li><li class="md-nav__item"><a href="../before-you-begin/setup-s3-and-resources.html" title="Set Up S3 for File Storage" class="md-nav__link">Set Up S3 for File Storage</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7"><label class="md-nav__link" for="nav-7">How to Guides</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-7">How to Guides</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="upgrade-existing-opsman.html" title="Upgrading an Existing Ops Manager" class="md-nav__link">Upgrading an Existing Ops Manager</a></li><li class="md-nav__item"><a href="install-opsman.html" title="Installing Ops Manager" class="md-nav__link">Installing Ops Manager</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8"><label class="md-nav__link" for="nav-8">References</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-8">References</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../reference/task.html" title="Tasks" class="md-nav__link">Tasks</a></li><li class="md-nav__item"><a href="../reference/inputs-outputs.html" title="Inputs/Outputs" class="md-nav__link">Inputs/Outputs</a></li><li class="md-nav__item"><a href="../reference/running-commands-locally.html" title="Running Commands Locally" class="md-nav__link">Running Commands Locally</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9"><label class="md-nav__link" for="nav-9">Configuration Management</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-9">Configuration Management</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../configuration-management/configure-auth.html" title="Configure Auth" class="md-nav__link">Configure Auth</a></li><li class="md-nav__item"><a href="../configuration-management/creating-a-director-config-file.html" title="Creating a Director Config File" class="md-nav__link">Creating a Director Config File</a></li><li class="md-nav__item"><a href="../configuration-management/creating-a-product-config-file.html" title="Creating a Product Config File" class="md-nav__link">Creating a Product Config File</a></li><li class="md-nav__item"><a href="../configuration-management/configure-env.html" title="Configuring Env" class="md-nav__link">Configuring Env</a></li><li class="md-nav__item"><a href="../configuration-management/secrets-handling.html" title="Secrets Handling" class="md-nav__link">Secrets Handling</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10"><label class="md-nav__link" for="nav-10">Pipeline Design</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-10">Pipeline Design</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../pipeline-design/variables.html" title="Variables" class="md-nav__link">Variables</a></li><li class="md-nav__item"><a href="../pipeline-design/stemcell-handling.html" title="Stemcell Handling" class="md-nav__link">Stemcell Handling</a></li></ul></nav></li><li class="md-nav__item"><a href="../upgrade.html" title="About Upgrading Ops Manager" class="md-nav__link">About Upgrading Ops Manager</a></li><li class="md-nav__item"><a href="../report-an-issue.html" title="Report an Issue" class="md-nav__link">Report an Issue</a></li></ul></nav></div></div></div><div class="md-sidebar md-sidebar--secondary" data-md-component="toc"><div class="md-sidebar__scrollwrap"><div class="md-sidebar__inner"><nav class="md-nav md-nav--secondary"><label class="md-nav__title" for="__toc">Table of contents</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="#prerequisites" title="Prerequisites" class="md-nav__link">Prerequisites</a></li><li class="md-nav__item"><a href="#goals-and-overview" title="Goals and Overview" class="md-nav__link">Goals and Overview</a></li><li class="md-nav__item"><a href="#retrieving-resources-from-pivnet" title="Retrieving Resources from Pivnet" class="md-nav__link">Retrieving Resources from Pivnet</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#parametrizing-secrets-and-using-credhub-interpolate" title="Parametrizing Secrets, and Using Credhub Interpolate" class="md-nav__link">Parametrizing Secrets, and Using Credhub Interpolate</a></li><li class="md-nav__item"><a href="#download-product-and-products-stemcell" title="Download Product and Product's Stemcell" class="md-nav__link">Download Product and Product's Stemcell</a></li><li class="md-nav__item"><a href="#download-platform-automation-from-pivnet" title="Download Platform Automation from Pivnet" class="md-nav__link">Download Platform Automation from Pivnet</a></li><li class="md-nav__item"><a href="#a-complete-resources-pipeline" title="A Complete Resources Pipeline" class="md-nav__link">A Complete Resources Pipeline</a></li></ul></nav></li><li class="md-nav__item"><a href="#sample-github-repository-and-file-structure" title="Sample Github repository and file structure" class="md-nav__link">Sample Github repository and file structure</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#git-and-github" title="Git and Github" class="md-nav__link">Git and Github</a></li><li class="md-nav__item"><a href="#creating-repo-directory-structure" title="Creating Repo Directory Structure" class="md-nav__link">Creating Repo Directory Structure</a></li></ul></nav></li><li class="md-nav__item"><a href="#creating-the-required-files" title="Creating the Required Files" class="md-nav__link">Creating the Required Files</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#ops-manager-vm-state" title="Ops Manager VM State" class="md-nav__link">Ops Manager VM State</a></li><li class="md-nav__item"><a href="#ops-manager-vm-configuration" title="Ops Manager VM Configuration" class="md-nav__link">Ops Manager VM Configuration</a></li><li class="md-nav__item"><a href="#ops-manager-environment-file" title="Ops Manager Environment File" class="md-nav__link">Ops Manager Environment File</a></li><li class="md-nav__item"><a href="#vars-files" title="Vars files" class="md-nav__link">Vars files</a></li><li class="md-nav__item"><a href="#valid-exported-ops-manager-installation" title="Valid exported Ops Manager installation" class="md-nav__link">Valid exported Ops Manager installation</a></li></ul></nav></li><li class="md-nav__item"><a href="#retrieving-existing-ops-manager-director-configuration" title="Retrieving Existing Ops Manager Director Configuration" class="md-nav__link">Retrieving Existing Ops Manager Director Configuration</a></li><li class="md-nav__item"><a href="#retrieving-existing-product-configurations" title="Retrieving Existing Product Configurations" class="md-nav__link">Retrieving Existing Product Configurations</a></li><li class="md-nav__item"><a href="#creating-a-pipeline-to-upgrade-ops-manager" title="Creating a Pipeline to Upgrade Ops Manager" class="md-nav__link">Creating a Pipeline to Upgrade Ops Manager</a></li><li class="md-nav__item"><a href="#troubleshooting" title="Troubleshooting" class="md-nav__link">Troubleshooting</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#version-check-errors" title="Version Check Errors" class="md-nav__link">Version Check Errors</a></li><li class="md-nav__item"><a href="#iaas-cli-errors" title="IAAS CLI Errors" class="md-nav__link">IAAS CLI Errors</a></li><li class="md-nav__item"><a href="#todo" title="TODO" class="md-nav__link">TODO</a></li></ul></nav></li></ul></nav></div></div></div><div class="md-content"><article class="md-content__inner md-typeset"><a href="https://github.com/pivotal/docs-platform-automation/edit/develop/docs/how-to-guides/brainDump.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a><h1 id="how-to-upgrade-an-existing-ops-manager">How to: Upgrade an Existing Ops Manager</h1>
<p>The following is a <em>How To Guide</em> on setting up and using Platform Automation.
This guide assumes you already have a foundation that needs to be automated, 
or you are coming from a different form of automation (such as <code>pcf-pipelines</code>)</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>In addition to the prerequisites listed in <a href="../downloading-and-testing.html">Downloading and Testing</a>,
the Platform Automation team recommends the following:</p>
<ul>
<li>
<p>Installed <a href="https://docs.docker.com/engine/reference/commandline/cli/">Docker CLI</a></p>
<p>There are a couple one-off tasks that can be either saved in your pipeline, 
or run once from the command line using our Docker image. The preference to 
do either is your choice, but the How To Guide will be using the Docker CLI.</p>
</li>
<li>
<p>Basic knowledge of <a href="https://git-scm.com/">Git</a>, and a <a href="https://github.com/">GitHub</a> account.</p>
<p>Several tasks mutate state and configuration files
that are best persisted in a remote version control system.
For the purposes of this guide, we'll use GitHub.</p>
</li>
<li>
<p><a href="https://aws.amazon.com/s3/">Amazon S3</a> or <a href="https://min.io/">Minio</a></p>
<p>While any blobstore may be used, this <em>How To Guide</em> will be 
using an s3-compatible blobstore.</p>
</li>
<li>
<p>A fully installed foundation (either PAS or PKS) with all relevant tiles similarly
  configured and installed</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Upgrading Ops Manager <em>requires</em> that your foundation have no pending apply-changes.
The exported installation will not reflect any pending changes, and will not export 
at all if the foundation has not fully installed at least the Ops Manager BOSH director.</p>
</div>
</li>
</ul>
<h2 id="goals-and-overview">Goals and Overview</h2>
<p>The goal of this How To Guide is to build up a portion of the <a href="../pipeline/multiple-products.html">Reference Pipeline</a>
and the <a href="../pipeline/resources.html">Reference Resources Pipeline</a>
that is relevant for upgrading Ops Manager for an already existing foundation. This guide will go 
through the following steps:</p>
<ol>
<li>Retrieving Ops Manager, PAS, Healthwatch, and Platform Automation from Pivnet and storing 
  in an s3 blobstore</li>
<li>How to interpolate the configs using credhub, and feeding these interpolated configs into 
   the concourse tasks</li>
<li>How to setup a sample github repo </li>
<li>Setup recommended file structure</li>
<li>Create required files for Upgrade</li>
<li>Retrieve the existing config from Ops Manager using <code>docker run</code></li>
<li>Retrieve the existing config from PAS and Healthwatch using <code>docker run</code></li>
<li>Create a pipeline to upgrade Ops Manager</li>
</ol>
<p>TODO: link the above to the headers below (after design review)</p>
<h2 id="retrieving-resources-from-pivnet">Retrieving Resources from Pivnet</h2>
<p>When creating a Concourse pipeline, we will expand the following base structure:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">resource_types</span><span class="p">:</span>
<span class="nt">resources</span><span class="p">:</span>
<span class="nt">jobs</span><span class="p">:</span>
</pre></div>
</td></tr></table></p>
<p>Concourse has many <a href="https://concourse-ci.org/resource-types.html">Resource Types</a> built in, but for the 
purpose of this reference pipeline, we will be utilizing the <a href="https://github.com/pivotal-cf/pivnet-resource">Pivotal pivnet-resource</a>
to directly communicate with and download products from Pivnet.</p>
<p>To tell concourse that we will be using the Pivnet resource, we will have to include
the following in your <code>resource_types</code> section:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pivnet</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker-image</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pivotalcf/pivnet-resource</span>
    <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">latest-final</span>
</pre></div>
</td></tr></table></p>
<p>After listing the "custom" resource type, we can then list the resources that our foundation
requires. For this guide, our foundation includes: Ops Manager, Pivotal Application Service (PAS),
and Healthwatch. The general automated workflow for fetching and storing resources is as follows:</p>
<p>TODO: link to the appropriate sections (after design review)</p>
<ol>
<li>Setup your s3 with the appropriate credentials/buckets for your foundation</li>
<li><a href="#download-product-and-products-stemcell">Download product and stemcell</a> (using <code>download-product</code>) 
   and store in an s3 bucket</li>
<li>Download Platform Automation from Pivnet</li>
</ol>
<p>The resources required to accomplish these tasks include:</p>
<ul>
<li>healthwatch-product s3 storage location</li>
<li>healthwatch-stemcell s3 storage location</li>
<li>ops-manager s3 storage location</li>
<li>pas-product s3 storage location</li>
<li>pas-stemcell s3 storage location</li>
<li>platform-automation-docker-image s3 storage location</li>
<li>platform-automation-tasks storage location</li>
</ul>
<p>To reference the storage locations in Concourse, you are required to have the </p>
<ul>
<li>access_key_id and secret_access_key for accessing the appropriate bucket</li>
<li>the name of the bucket for storing the product(s)</li>
<li>the region the bucket is located in</li>
<li>a regex that describes the filename of the product being stored (to prevent the
  wrong product/version from being stored/accessed later) </li>
</ul>
<p>The following example assumes that all of your products live in the same s3 bucket, thus
their <code>regexp</code> are very specific to match the slug/version.</p>
<p>To retrieve the platform-automation product, there is no stemcell, and thus the download
process is much simpler than with Ops Manager products. Therefore, we can use the Pivnet
resource we defined earlier and pull from Pivnet directly. The product can be stored in s3
the same way that the other products can. We can add all of these resources to our pipeline
under the <code>resources</code> section:</p>
<div class="superfences-tabs">
<input name="__tabs_1" type="radio" id="__tab_1_0" checked="checked" />
<label for="__tab_1_0">Healthwatch</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">healthwatch-product</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">\[p-healthwatch,(.*)\]p-healthwatch-.*.pivotal</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">healthwatch-stemcell</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">healthwatch-stemcell/\[stemcells-ubuntu-xenial,(.*)\]bosh-stemcell-.*-vsphere.*\.tgz</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_1" type="radio" id="__tab_1_1" />
<label for="__tab_1_1">PAS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pas-product</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">\[elastic-runtime,(.*)\]cf-.*.pivotal</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pas-stemcell</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pas-stemcell/\[stemcells-ubuntu-xenial,(.*)\]bosh-stemcell-.*-vsphere.*\.tgz</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_1" type="radio" id="__tab_1_2" />
<label for="__tab_1_2">Ops Manager</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">opsman-product</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">\[ops-manager,(.*)\].*.ova</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_1" type="radio" id="__tab_1_3" />
<label for="__tab_1_3">Platform Automation</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-pivnet</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pivnet</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">api_token</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((pivnet_token))</span>
    <span class="nt">product_slug</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation</span>
    <span class="nt">product_version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2\.(.*)</span>
    <span class="nt">sort_by</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">semver</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks-(.*).zip</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image-(.*).tgz</span>
</pre></div>
</td></tr></table></div>
</div>
<h3 id="parametrizing-secrets-and-using-credhub-interpolate">Parametrizing Secrets, and Using Credhub Interpolate</h3>
<p>This example pipeline will make heavy use of the <a href="../reference/task.html#credhub-interpolate"><code>credhub-interpolate</code></a>
task. For more information on how this works, and how to set it up and use it properly, 
please see the <a href="../configuration-management/secrets-handling.html">Secrets Handling</a> page. </p>
<p>The <a href="../reference/inputs-outputs.html#download-product-config">config file</a> used in the following section mixes secret and 
non-secret variables. When choosing which variables to keep in the config file, and which ones
to <code>((parametrize))</code>, you should consider whether public access to the variable would be a 
concern. If choosing to parametrize, you will need to first use 
<a href="../reference/task.html#credhub-interpolate"><code>credhub-interpolate</code></a> to substitute the Credhub values into the config 
for the next task to use. </p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Parametrized configurations that are interpolated by Credhub return a config file with the 
formerly parametrized variables with their Credhub values. Concourse VMs are ephemeral, and
these full config files are only available in the specific job, and will not be persisted.</p>
</div>
<p>An example of how to use this in the resources pipeline is shown below. We will be defining this
"task" external to jobs and resources, so that it can be used in multiple jobs while keeping the yaml
clean.
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">resource-types</span><span class="p">:</span>
<span class="nt">resources</span><span class="p">:</span>

<span class="nt">credhub-interpolate</span><span class="p">:</span> <span class="nl">&amp;credhub-interpolate</span>
  <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
  <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/credhub-interpolate.yml</span>
  <span class="nt">params</span><span class="p">:</span>
    <span class="nt">CREDHUB_CLIENT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-client))</span>
    <span class="nt">CREDHUB_SECRET</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-secret))</span>
    <span class="nt">CREDHUB_SERVER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-server))</span>
    <span class="nt">PREFIX</span><span class="p">:</span> <span class="s">&#39;/pipeline/vsphere&#39;</span>
    <span class="nt">INTERPOLATION_PATHS</span><span class="p">:</span> <span class="s">&quot;download-product-configs&quot;</span>
  <span class="nt">input_mapping</span><span class="p">:</span>
    <span class="nt">files</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span>
  <span class="nt">output_mapping</span><span class="p">:</span>
    <span class="nt">interpolated-files</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span>

<span class="nt">jobs</span><span class="p">:</span>
</pre></div>
</td></tr></table></p>
<p>When referencing the above "task" we will be calling it with the yaml below. This will expand the 
anchor <code>*credhub-interpolate</code> with the concourse-readable data we defined in <code>&amp;credhub-interpolate</code> above.
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">credhub-interpolate</span>
  <span class="nt">&lt;&lt;</span><span class="p">:</span> <span class="nv">*credhub-interpolate</span>
</pre></div>
</td></tr></table></p>
<h3 id="download-product-and-products-stemcell">Download Product and Product's Stemcell</h3>
<p>Before downloading a product,
you need a <a href="../reference/inputs-outputs.html#download-product-config">config file</a>
for <a href="../reference/task.html#download-product">download-product</a>.</p>
<p>Commented out fields are entirely optional and should only be used if you have a need to do 
so. Explanations for each field are given below.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">pivnet-api-token</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((pivnet-api-token))</span>
<span class="c1">## Note that file globs must be quoted if they start with *;</span>
<span class="c1">## otherwise they&#39;ll be interpreted as a YAML anchor.</span>
<span class="nt">pivnet-file-glob</span><span class="p">:</span> <span class="s">&quot;*.pivotal&quot;</span>
<span class="nt">pivnet-product-slug</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">product-slugs</span>

<span class="c1">## Either product-version OR product-version-regex is required</span>
<span class="c1"># product-version: 1.2.3</span>

<span class="c1">## Note that the regex mustn&#39;t be quoted,</span>
<span class="c1">## as escape characters for the regex will confuse yaml parsers.</span>
<span class="nt">product-version-regex</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">^1\.2\..*$</span>

<span class="nt">stemcell-iaas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">google</span>

<span class="c1">## The following are required only if using download-product-s3.</span>
<span class="c1">## Any key marked required above is still required when using S3.</span>
<span class="c1">## If s3-bucket is set,</span>
<span class="c1">## downloaded product files will have their slug and version prepended.</span>
<span class="nt">s3-bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3-bucket</span>
<span class="nt">s3-region-name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">us-west-1</span>      <span class="c1"># required; sufficient for AWS</span>
<span class="nt">s3-endpoint</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3.endpoint.com</span>   <span class="c1"># if not using AWS, this is required</span>

<span class="c1">## Required unless `s3-auth-method` is `iam`</span>
<span class="nt">s3-access-key-id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3-access-key-id))</span>
<span class="nt">s3-secret-access-key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3-secret-access-key))</span>
</pre></div>
</td></tr></table>

<p>To fetch a product from Pivnet, concourse needs to know:</p>
<ul>
<li>what image it will run the task on (<code>platform-automation-image</code>)</li>
<li>where the task file will come from (<code>platform-automation-tasks</code>) </li>
<li>what config file it will read from to get data about pivnet and the tile (this is 
  the <code>download-product-config</code> created above)</li>
<li>how to map the output from the task to something you will use later</li>
<li>where to put the output resources created in the task</li>
</ul>
<p>These requirements gathered together and executed in a task could look like the snippet below.
The snippet involves downloading Healthwatch. However, Healthwatch can be easily replaced by
any other tile. The only pieces that would need to change are the task name (if being specific), 
the name of the stemcell (if mapping), the name of the <code>download-product-config</code>, and the <code>put</code>'s 
specified after the product and stemcell are downloaded. </p>
<div class="superfences-tabs">
<input name="__tabs_2" type="radio" id="__tab_2_0" checked="checked" />
<label for="__tab_2_0">Healthwatch</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">download-healthwatch-product-and-stemcell</span>
  <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
  <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/download-product.yml</span>
  <span class="nt">params</span><span class="p">:</span>
    <span class="nt">CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">download-product-configs/healthwatch.yml</span>
  <span class="nt">output_mapping</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt">downloaded-stemcell</span><span class="p">:</span> <span class="nv">healthwatch-stemcell</span><span class="p p-Indicator">}</span>
    <span class="p p-Indicator">-</span> <span class="nt">aggregate</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">healthwatch-product</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">downloaded-product/*.pivotal</span>
    <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">healthwatch-stemcell</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">healthwatch-stemcell/*.tgz</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_2" type="radio" id="__tab_2_1" />
<label for="__tab_2_1">PAS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">download-pas-product-and-stemcell</span>
  <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
  <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/download-product.yml</span>
  <span class="nt">params</span><span class="p">:</span>
    <span class="nt">CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">download-product-configs/pas.yml</span>
  <span class="nt">output_mapping</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt">downloaded-stemcell</span><span class="p">:</span> <span class="nv">pas-stemcell</span><span class="p p-Indicator">}</span>
    <span class="p p-Indicator">-</span> <span class="nt">aggregate</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pas-product</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">downloaded-product/*.pivotal</span>
    <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pas-stemcell</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pas-stemcell/*.tgz</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Concourse requires tasks to be within jobs.
For convenience,
and ease of explanation,
we have created a separate job for each product.
These tasks can easily be combined into a single job.
Benefits of doing this could include running <code>credhub-interpolate</code> only once,
(instead of once for each job).
One downside of structuring your pipeline with many tasks in a given job
is that you lose the ability to rerun just a particular section of the job that failed.
This means Concourse would run every task again
if the job was triggered a second time.</p>
<p>To make sure your blobstore always has the most recent version of a pivnet product, you can use the
built-in time resource, to tell the <code>fetch</code> jobs how often to run and attempt to download a new version
of the product and/or stemcell. To add this functionality to your pipeline, you must include the time
resource in your <code>resources</code> section:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">daily-trigger</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">time</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">24h</span>
</pre></div>
</td></tr></table></p>
<p>If included, this resource can be referenced in any appropriate job, and you can set the job to trigger
on that daily (or custom) interval.</p>
<p>Examples of the <code>fetch-{product}</code> job are shown below. The job includes the task we created above,
the daily time trigger, and the interpolate created in an 
<a href="#parametrizing-secrets-and-using-credhub-interpolate">earlier step</a>. These jobs should be included under the 
<code>jobs</code> header in your pipeline.</p>
<div class="superfences-tabs">
<input name="__tabs_3" type="radio" id="__tab_3_0" checked="checked" />
<label for="__tab_3_0">Healthwatch</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fetch-healthwatch</span>
  <span class="nt">plan</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">aggregate</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">daily</span>
          <span class="nt">trigger</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">unpack</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">unpack</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">credhub-interpolate</span>
      <span class="nt">&lt;&lt;</span><span class="p">:</span> <span class="nv">*credhub-interpolate</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">download-healthwatch-product-and-stemcell</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/download-product.yml</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">download-product-configs/healthwatch.yml</span>
      <span class="nt">output_mapping</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt">downloaded-stemcell</span><span class="p">:</span> <span class="nv">healthwatch-stemcell</span><span class="p p-Indicator">}</span>
    <span class="p p-Indicator">-</span> <span class="nt">aggregate</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">healthwatch-product</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">downloaded-product/*.pivotal</span>
        <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">healthwatch-stemcell</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">healthwatch-stemcell/*.tgz</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_3" type="radio" id="__tab_3_1" />
<label for="__tab_3_1">PAS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fetch-pas</span>
  <span class="nt">plan</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">aggregate</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">daily</span>
          <span class="nt">trigger</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">unpack</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">unpack</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">credhub-interpolate</span>
      <span class="nt">&lt;&lt;</span><span class="p">:</span> <span class="nv">*credhub-interpolate</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">download-pas-product-and-stemcell</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/download-product.yml</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">download-product-configs/pas.yml</span>
      <span class="nt">output_mapping</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt">downloaded-stemcell</span><span class="p">:</span> <span class="nv">pas-stemcell</span><span class="p p-Indicator">}</span>
    <span class="p p-Indicator">-</span> <span class="nt">aggregate</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pas-product</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">downloaded-product/*.pivotal</span>
        <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pas-stemcell</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pas-stemcell/*.tgz</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_3" type="radio" id="__tab_3_2" />
<label for="__tab_3_2">Ops Manager</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fetch-opsman</span>
  <span class="nt">plan</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">aggregate</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">daily</span>
          <span class="nt">trigger</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">unpack</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">unpack</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">credhub-interpolate</span>
      <span class="nt">&lt;&lt;</span><span class="p">:</span> <span class="nv">*credhub-interpolate</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">download-opsman-image</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/download-product.yml</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">download-product-configs/opsman.yml</span>
    <span class="p p-Indicator">-</span> <span class="nt">aggregate</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">opsman-product</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">downloaded-product/*</span>
</pre></div>
</td></tr></table></div>
</div>
<h3 id="download-platform-automation-from-pivnet">Download Platform Automation from Pivnet</h3>
<p>Downloading the Platform Automation toolset does not use <code>download-product</code>.
Using download-product for this would require the product have a dependency on itself.
Instead, we use the <code>pivnet-resource</code> we defined earlier.</p>
<p>The Platform Automation team recommends triggering <code>fetch-platform-automation</code>
whenever there is a new version available.
The resource definition for platform automation from above
is pinned to the major version.
Pinning to the major version but letting the minor and patch version increase
allows you to get security updates, bug fixes, and new (non-breaking) features.
Platform Automation uses <a href="../compatibility-and-versioning.html#semantic-versioning">semantic versioning</a> to enable this.</p>
<p>To download the Platform Automation tasks and the Docker image, and put it into your s3 blobstore, add
the following <code>job</code>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fetch-platform-automation</span>
  <span class="nt">plan</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-pivnet</span>
      <span class="nt">trigger</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="p p-Indicator">-</span> <span class="nt">aggregate</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-pivnet/*tasks*.zip</span>
        <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-pivnet/*image*.tgz</span>
</pre></div>
</td></tr></table></p>
<h3 id="a-complete-resources-pipeline">A Complete Resources Pipeline</h3>
<p>Now that we have built up the resources pipeline, you can find this full example on the 
<a href="../pipeline/resources.html">Reference Pipeline</a> page. This also includes an example of fetching a 
Windows tile, but if you understand the concepts above, you can use the Windows tile, the mySQL tile, 
or any other tile you desire for your foundation.</p>
<h2 id="sample-github-repository-and-file-structure">Sample Github repository and file structure</h2>
<p>Now let's dive into using version control
to manage state in pipelines built with Platform Automation.
We'll set up a git repository on Github,
and the recommended directory structure for the repo. </p>
<h3 id="git-and-github">Git and Github</h3>
<p>Git is a commonly used version control tool.
It can be used to track code changes made to files within a repository (or "repo").
Changes can then be "pushed" to or "pulled" from remote copies of that repository.</p>
<p>Github is a system that provides git remotes.
Using a remote will enable the pipeline we are creating
to access and update the state and configuration files.</p>
<p>To learn more about git and github,
you can <a href="https://guides.github.com/introduction/git-handbook/">read this short git handbook</a>.</p>
<p>To create our Github repo:</p>
<ol>
<li>Create a new repository</li>
<li>Using the "Example: Start a new repository and publish it to GitHub"
   section of the <a href="https://guides.github.com/introduction/git-handbook/">Git handbook</a> (about 3/4 down the page), 
   create a repo, add a file, and push it to Github.</li>
</ol>
<h3 id="creating-repo-directory-structure">Creating Repo Directory Structure</h3>
<p>You now have both a local git repo and a remote on Github.
The recommended structure for a config repo is:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="err">├──</span> <span class="n">foundation</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">config</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">env</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="k">state</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">vars</span>
</pre></div>
</td></tr></table>

<p>These directories are needed for this guide.</p>
<table>
    <tr>
        <td>config</td>
        <td>
            Holds config files for the products installed on your foundation.
            If using Credhub and/or vars files,
            these config files should have your <code>((parametrized))</code> values present in them
        </td>
    </tr>
    <tr>
        <td>env</td>
        <td>
            Holds <code>env.yml</code>,
            the environment file used by tasks that interact with Ops Manager.
        </td>
    </tr>
    <tr>
        <td>vars</td>
        <td>
          Holds product-specific vars files.
        </td>
    </tr>
    <tr>
        <td>state</td>
        <td>
            Holds <code>state.yml</code>,
            which contains the VM ID for the Ops Manager VM.
        </td>
    </tr>
</table>

<h2 id="creating-the-required-files">Creating the Required Files</h2>
<p>Several files are required for upgrading an Ops Manager VM.
They are used to capture the current state of the Ops Manager VM.</p>
<h3 id="ops-manager-vm-state">Ops Manager VM State</h3>
<p>We'll need to capture the current Ops Manager VM identifier,
so we know what VM we are upgrading.
To create a <code>state.yml</code> from your existing foundation,
use the following as a template, based on your IaaS:</p>
<div class="superfences-tabs">
<input name="__tabs_4" type="radio" id="__tab_4_0" checked="checked" />
<label for="__tab_4_0">AWS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">iaas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">aws</span>
<span class="c1"># Instance ID of the AWS VM</span>
<span class="nt">vm_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">i-12345678987654321</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_4" type="radio" id="__tab_4_1" />
<label for="__tab_4_1">Azure</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">iaas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure</span>
<span class="c1"># Computer Name of the Azure VM</span>
<span class="nt">vm_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vm_name</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_4" type="radio" id="__tab_4_2" />
<label for="__tab_4_2">GCP</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">iaas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gcp</span>
<span class="c1"># Name of the VM in GCP</span>
<span class="nt">vm_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vm_name</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_4" type="radio" id="__tab_4_3" />
<label for="__tab_4_3">OpenStack</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">iaas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">openstack</span>
<span class="c1"># Instance ID from the OpenStack Overview</span>
<span class="nt">vm_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">12345678-9876-5432-1abc-defghijklmno</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_4" type="radio" id="__tab_4_4" />
<label for="__tab_4_4">vSphere</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">iaas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vsphere</span>
<span class="c1"># Path to the VM in vCenter</span>
<span class="nt">vm_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/datacenter/vm/folder/vm_name</span>
</pre></div>
</td></tr></table></div>
</div>
<h3 id="ops-manager-vm-configuration">Ops Manager VM Configuration</h3>
<p><code>opsman.yml</code> is the configuration file for <code>p-automator</code>,
which calls out to specific IaaS CLIs in order to create/update/delete a VM.</p>
<p>The properties contained in <code>opsman.yml</code> differ based on your IaaS:</p>
<div class="superfences-tabs">
<input name="__tabs_5" type="radio" id="__tab_5_0" checked="checked" />
<label for="__tab_5_0">AWS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># code_snippet aws-configuration start yaml</span>
<span class="nn">---</span>
<span class="nt">opsman-configuration</span><span class="p">:</span>
  <span class="nt">aws</span><span class="p">:</span>
    <span class="nt">region</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">us-west-2</span>
    <span class="nt">vm_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ops-manager-vm</span> <span class="c1"># defaults Ops Manager-vm</span>
    <span class="nt">boot_disk_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span> <span class="c1"># default 200</span>
    <span class="nt">vpc_subnet_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">subnet-0292bc845215c2cbf</span>
    <span class="nt">security_group_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sg-0354f804ba7c4bc41</span>
    <span class="nt">key_pair_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ops-manager-key</span>
    <span class="nt">iam_instance_profile_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ops-manager-iam</span>
    <span class="nt">instance_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">m5.large</span>
    <span class="c1"># At least one IP address (public or private)</span>
    <span class="c1"># needs to be assigned to the VM.</span>
    <span class="c1"># It is also permissable to assign both.</span>
    <span class="nt">public_ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.2.3.4</span>
    <span class="nt">private_ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.0.0.2</span>

    <span class="c1"># Required if use_instance_profile is false</span>
    <span class="c1"># omit if using Instance Profiles</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-access-id</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-secret-access-key</span>

    <span class="c1"># If using Instance Profiles (omit if using AWS Credentials)</span>
    <span class="nt">use_instance_profile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span> <span class="c1"># default false</span>

    <span class="c1"># Optional, necessary if a role is needed to authorize the instance profile</span>
    <span class="nt">assume_role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">arn:aws:iam::123456789:role/test</span>
<span class="c1"># code_snippet aws-configuration end</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_5" type="radio" id="__tab_5_1" />
<label for="__tab_5_1">Azure</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># code_snippet azure-configuration start yaml</span>
<span class="nn">---</span>
<span class="nt">opsman-configuration</span><span class="p">:</span>
  <span class="nt">azure</span><span class="p">:</span>
    <span class="nt">subscription_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">90f35f10-ea9e-4e80-aac4-d6778b995532</span>
    <span class="nt">resource_group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">res-group</span>
    <span class="nt">tenant_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3e52862f-a01e-4b97-98d5-f31a409df682</span>
    <span class="nt">client_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5782deb6-9195-4827-83ae-a13fda90aa0d</span>
    <span class="nt">client_secret</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">6Iaue71Lqxfq</span>
    <span class="nt">location</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">westus</span>
    <span class="nt">container</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">opsmanagerimage</span>                    <span class="c1"># container for opsman image</span>
    <span class="nt">network_security_group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ops-manager-security-group</span>

    <span class="c1"># Note that there are several environment-specific details in this path</span>
    <span class="nt">vpc_subnet</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/subscriptions/&lt;MY_SUBSCRIPTION_ID&gt;/resourceGroups/&lt;MY_RESOURCE_GROUP&gt;/providers/Microsoft.Network/virtualNetworks/&lt;MY_VNET&gt;/subnets/&lt;MY_SUBNET&gt;</span>

    <span class="nt">storage_account</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">opsman</span>                       <span class="c1"># account name of container</span>

    <span class="c1"># Optional</span>
    <span class="c1"># only needed if your client doesn&#39;t have the needed storage permissions</span>
    <span class="nt">storage_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pEuXDaDK/WWo...</span>

    <span class="nt">ssh_public_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ssh-rsa AAAAB3NzaC1yc2EAZ...</span>  <span class="c1"># ssh key to access VM</span>
    <span class="nt">vm_name</span><span class="p">:</span> <span class="nt">ops-manager-vm                       # default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ops Manager-vm</span>
    <span class="nt">boot_disk_size</span><span class="p">:</span> <span class="nt">100                           # default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">200</span>
    <span class="nt">cloud_name</span><span class="p">:</span> <span class="nt">AzureCloud                        # default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AzureCloud</span>

    <span class="c1"># This flag is only respected by the create-vm &amp; upgrade-opsman commands</span>
    <span class="c1"># set to true if you want to create the new opsman vm with unmanaged disk</span>
    <span class="c1"># delete-vm discovers the disk type from the VM</span>
    <span class="nt">use_unmanaged_disk</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>

    <span class="c1"># At least one IP address (public or private)</span>
    <span class="c1"># needs to be assigned to the VM.</span>
    <span class="c1"># It is also permissable to assign both.</span>
    <span class="nt">public_ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.2.3.4</span>
    <span class="nt">private_ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.0.0.3</span>
<span class="c1"># code_snippet azure-configuration end</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_5" type="radio" id="__tab_5_2" />
<label for="__tab_5_2">GCP</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># code_snippet gcp-configuration start yaml</span>
<span class="nn">---</span>
<span class="nt">opsman-configuration</span><span class="p">:</span>
  <span class="nt">gcp</span><span class="p">:</span>
    <span class="nt">gcp_service_account</span><span class="p">:</span> <span class="p p-Indicator">|</span>
      <span class="no">{</span>
        <span class="no">&quot;type&quot;: &quot;service_account&quot;,</span>
        <span class="no">&quot;project_id&quot;: &quot;project-id&quot;,</span>
        <span class="no">&quot;private_key_id&quot;: &quot;af719b1ca48f7b6ac67ca9c5319cb175&quot;,</span>
        <span class="no">&quot;private_key&quot;: &quot;-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n&quot;,</span>
        <span class="no">&quot;client_email&quot;: &quot;user@project-id.iam.gserviceaccount.com&quot;,</span>
        <span class="no">&quot;client_id&quot;: &quot;1234567890&quot;,</span>
        <span class="no">&quot;auth_uri&quot;: &quot;https://accounts.google.com/o/oauth2/auth&quot;,</span>
        <span class="no">&quot;token_uri&quot;: &quot;https://accounts.google.com/o/oauth2/token&quot;,</span>
        <span class="no">&quot;auth_provider_x509_cert_url&quot;: &quot;https://www.googleapis.com/oauth2/v1/certs&quot;,</span>
        <span class="no">&quot;client_x509_cert_url&quot;: &quot;https://www.googleapis.com/robot/v1/metadata/x509/user%40project-id.iam.gserviceaccount.com&quot;</span>
      <span class="no">}</span>
    <span class="nt">project</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">project-id</span>
    <span class="nt">region</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">us-central1</span>
    <span class="nt">zone</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">us-central1-b</span>
    <span class="nt">vm_name</span><span class="p">:</span> <span class="nt">ops-manager-vm               # default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ops Manager-vm</span>
    <span class="c1"># For SharedVPC: projects/[HOST_PROJECT_ID]/regions/[REGION]/subnetworks/[SUBNET]</span>
    <span class="nt">vpc_subnet</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">infrastructure-subnet</span>
    <span class="nt">tags</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ops-manager</span>
    <span class="c1"># This CPU, Memory and disk size demonstrated here</span>
    <span class="c1"># match the defaults, and needn&#39;t be included if these are the desired values</span>
    <span class="nt">custom_cpu</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
    <span class="nt">custom_memory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8</span>
    <span class="nt">boot_disk_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
    <span class="c1"># At least one IP address (public or private) needs to be assigned to the VM.</span>
    <span class="nt">public_ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.2.3.4.</span>
    <span class="nt">private_ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.0.0.2</span>
<span class="c1"># code_snippet gcp-configuration end</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_5" type="radio" id="__tab_5_3" />
<label for="__tab_5_3">OpenStack</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># code_snippet openstack-configuration start yaml</span>
<span class="nn">---</span>
<span class="nt">opsman-configuration</span><span class="p">:</span>
  <span class="nt">openstack</span><span class="p">:</span>
    <span class="nt">auth_url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http://os.example.com:5000/v2.0</span>
    <span class="nt">project_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">project</span>
    <span class="nt">net_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">26a13112-b6c2-11e8-96f8-529269fb1459</span>
    <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
    <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">password</span>
    <span class="nt">key_pair_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">opsman-keypair</span>
    <span class="nt">security_group_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">opsman-sec-group</span>
    <span class="nt">vm_name</span><span class="p">:</span> <span class="nt">ops-manager-vm      # default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ops Manager-vm</span>
    <span class="c1"># At least one IP address (public or private) needs to be assigned to the VM.</span>
    <span class="nt">public_ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.2.3.4</span>
    <span class="nt">private_ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.0.0.3</span>
    <span class="nt">flavor</span><span class="p">:</span> <span class="nt">m1.xlarge            # default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">m1.xlarge</span>
    <span class="nt">project_domain_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
    <span class="nt">user_domain_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
    <span class="nt">identity_api_version</span><span class="p">:</span> <span class="nt">3 # default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
    <span class="nt">insecure</span><span class="p">:</span> <span class="nt">true # default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
    <span class="nt">availability_zone</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">zone-01</span>
<span class="c1"># code_snippet openstack-configuration end</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_5" type="radio" id="__tab_5_4" />
<label for="__tab_5_4">vSphere</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># code_snippet vsphere-configuration start yaml</span>
<span class="nn">---</span>
<span class="nt">opsman-configuration</span><span class="p">:</span>
  <span class="nt">vsphere</span><span class="p">:</span>
    <span class="nt">vcenter</span><span class="p">:</span>
      <span class="nt">url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vcenter.example.com</span>
      <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
      <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">password</span>
      <span class="nt">datastore</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">exmple-ds-1</span>
      <span class="nt">ca_cert</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">certificate</span>
      <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">example-host</span>                     <span class="c1"># vCenter host to deploy Ops Manager in</span>
      <span class="nt">datacenter</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">example-dc</span>
      <span class="nt">resource_pool</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/example-dc/host/example-host/Resources/ResPool</span> <span class="c1"># or /&lt;Data Center Name&gt;/host/&lt;Cluster Name&gt;</span>
      <span class="nt">folder</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/example-dc/vm/Folder</span>
      <span class="nt">insecure</span><span class="p">:</span> <span class="nt">1                            # default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0 (secure); 1 (insecure)</span>
    <span class="nt">disk_type</span><span class="p">:</span> <span class="nt">thin                          # example</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">thin|thick</span>
    <span class="nt">private_ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.0.0.2</span>
    <span class="nt">dns</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8.8.8.8</span>
    <span class="nt">ntp</span><span class="p">:</span> <span class="nt">ntp.example.com                     # example</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ntp.ubuntu.com</span>
    <span class="nt">ssh_password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">password</span>
    <span class="nt">ssh_public_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ssh-rsa ......</span>           <span class="c1"># for Ops Manager &gt;= 2.3</span>
    <span class="nt">hostname</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pcf.example.com</span>
    <span class="nt">network</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">virtual-network</span>                 <span class="c1"># vcenter network to deploy to</span>
    <span class="nt">netmask</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">255.255.255.192</span>
    <span class="nt">gateway</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.10.1</span>
    <span class="nt">vm_name</span><span class="p">:</span> <span class="nt">Ops_Manager                     # default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ops_Manager</span>
    <span class="nt">memory</span><span class="p">:</span> <span class="nt">8                                # default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8 GB</span>
    <span class="nt">cpu</span><span class="p">:</span> <span class="nt">1                                   # default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="c1"># code_snippet vsphere-configuration end</span>
</pre></div>
</td></tr></table></div>
</div>
<h3 id="ops-manager-environment-file">Ops Manager Environment File</h3>
<p><code>env.yml</code> holds authentication and target information
for a particular Ops Manager.
This file is required by <code>upgrade-opsman</code>
because after the VM is recreated,
the task will import the provided installation.zip
to Ops Manager to finish the process.</p>
<p>If your foundation uses authentication other than basic auth,
please reference <a href="../reference/inputs-outputs.html#env">Inputs and Outputs</a> for more detail on UAA-based authentication.</p>
<p>An example <code>env.yml</code> is shown below.
As mentioned in the comment,
<code>decryption-passphrase</code> is required for <code>import-installation</code>,
and therefore required for <code>upgrade-opsman</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="nt">target</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://pcf.example.com</span>
<span class="nt">connect-timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>            <span class="c1"># default 5</span>
<span class="nt">request-timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1800</span>          <span class="c1"># default 1800</span>
<span class="nt">skip-ssl-validation</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>     <span class="c1"># default false</span>
<span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">username</span>
<span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">password</span>
<span class="c1"># decryption-passphrase is optional,</span>
<span class="c1"># except for use with `import-installation`.</span>
<span class="c1"># OpsMan depends on the passphrase</span>
<span class="c1"># to decrypt the imported installation.</span>
<span class="c1"># For other commands, providing this key allows</span>
<span class="c1"># decryption of the OpsMan VM after reboot,</span>
<span class="c1"># which would otherwise need to be done manually.</span>
<span class="nt">decryption-passphrase</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">passphrase</span>
</pre></div>
</td></tr></table>

<h3 id="vars-files">Vars files</h3>
<p>If you are using files to store vars be rendered into your configuration templates,
these files should be  in your git repo under the <code>vars</code> directory.
For more information on vars files, see <a href="../configuration-management/secrets-handling.html">Secrets Handling</a>.</p>
<h3 id="valid-exported-ops-manager-installation">Valid exported Ops Manager installation</h3>
<p><code>upgrade-opsman</code> will not allow you to execute the task unless the installation 
provided to the task is a installation provided by Ops Manager itself. In the UI, this is located 
on the <a href="https://docs.pivotal.io/pivotalcf/2-4/customizing/pcf-interface.html#-settings-page">Settings Page</a> of Ops Manager.</p>
<p>Platform Automation <em><strong>strongly recommends</strong></em> automatically exporting and persisting the Ops 
Manager installation on a regular basis. In order to do so, you can set your pipeline to run the 
<a href="../reference/task.html#export-installation"><code>export-installation</code></a> task on a daily trigger. This should be persisted into 
S3 or a blobstore of your choice.</p>
<p>You can start your pipeline by first creating this <code>export-installation</code> task and persisting it in an S3
bucket.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is recommended to persist the zip file exported from export-installation
 to an external file store (eg S3) on a regular basis.
 The exported installation can restore the Ops Manager
 to a working state if it is non-functional.</p>
</div>
<p>Requirements for this task include:</p>
<ul>
<li>the Platform Automation image</li>
<li>the Platform Automation tasks</li>
<li>a configuration path for your env file</li>
<li>interpolation of the env file with credhub</li>
<li>a resource to store the exported installation into</li>
</ul>
<p>Starting our concourse pipeline, we need the following resources:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.*tasks-(.*).zip</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.*image-(.*).tgz</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">git</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">private_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((configuration.private_key))</span>
    <span class="nt">uri</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((configuration.uri))</span>
    <span class="nt">branch</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">master</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.installation))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation-(.*).zip</span>
</pre></div>
</td></tr></table></p>
<p>In our <code>jobs</code> section, we need a job that will trigger daily to pull down the Ops Manager
installation and store it in S3. This looks like the following:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">export-installation</span>
  <span class="nt">serial</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">plan</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">aggregate</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">daily-trigger</span>
          <span class="nt">trigger</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">unpack</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">unpack</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">variable</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolate-env-creds</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/credhub-interpolate.yml</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">CREDHUB_CLIENT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-client))</span>
        <span class="nt">CREDHUB_SECRET</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-secret))</span>
        <span class="nt">CREDHUB_SERVER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-server))</span>
        <span class="nt">PREFIX</span><span class="p">:</span> <span class="s">&#39;/pipeline/vsphere&#39;</span>
        <span class="nt">INTERPOLATION_PATHS</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((foundation))/config</span>
        <span class="nt">SKIP_MISSING</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">input_mapping</span><span class="p">:</span>
        <span class="nt">files</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
      <span class="nt">output_mapping</span><span class="p">:</span>
        <span class="nt">interpolated-files</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolated-configs</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">export-installation</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/export-installation.yml</span>
      <span class="nt">input_mapping</span><span class="p">:</span>
        <span class="nt">env</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolated-env</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((foundation))/env/env.yml</span>
        <span class="nt">INSTALLATION_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation-$timestamp.zip</span>
    <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation/installation*.zip</span>
</pre></div>
</td></tr></table>

<p>Once this resource is persisted, we can safely run <code>upgrade-opsman</code>, knowing that we can 
never truly lose our foundation. This is also important in case something happens to the VM
externally (whether accidentally deleted, or a similar disaster occurs). If something <em>does</em>
happen to the original Ops Manager VM, this installation can be imported by any newly created Ops Manager
VM.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is recommended to persist the zip file exported from export-installation
 to an external file store (eg S3) on a regular basis.
 The exported installation can restore the Ops Manager
 to a working state if it is non-functional.</p>
</div>
<h2 id="retrieving-existing-ops-manager-director-configuration">Retrieving Existing Ops Manager Director Configuration</h2>
<p>If you would like to automate the configuration of your Ops Manager, you first need to externalize
the director configuration. Using Platform Automation, this is done using Docker or by adding a job to
the pipeline.</p>
<p><strong>Docker</strong></p>
<p>To get the currently configured Ops Manager configuration, we have to:</p>
<ol>
<li>
<p>Import the image
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker import <span class="si">${</span><span class="nv">PLATFORM_AUTOMATION_IMAGE_TGZ</span><span class="si">}</span> platform-automation-image
</pre></div>
</td></tr></table>
Where <code>${PLATFORM_AUTOMATION_IMAGE_TGZ}</code> is the image file downloaded from Pivnet.</p>
</li>
<li>
<p>Then, you can use <code>docker run</code> to pass it arbitrary commands.
Here, we're running the <code>om</code> CLI to see what commands are available:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker run -it --rm -v <span class="nv">$PWD</span>:/workspace -w /workspace platform-automation-image <span class="se">\</span>
om -h
</pre></div>
</td></tr></table></p>
</li>
</ol>
<p>Note:  that this will have access read and write files in your current working directory.
If you need to mount other directories as well, you can add additional <code>-v</code> arguments.</p>
<p>The command we will use to extract the current director configuration is called 
<a href="../reference/task.html#staged-director-config"><code>staged-director-config</code></a>. This is an <code>om</code> command that calls
the Ops Manager API to pull down the currently configured director configuration. To run this
using Docker, you will need the env file created above as <code>${ENV_FILE}</code>: </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker run -it --rm -v <span class="nv">$PWD</span>:/workspace -w /workspace platform-automation-image <span class="se">\</span>
om --env <span class="si">${</span><span class="nv">ENV_FILE</span><span class="si">}</span> staged-director-config --include-placeholders
</pre></div>
</td></tr></table>

<p><code>--include-placeholders</code> is an optional flag, but highly recommended if you want a full
configuration for your Ops Manager. This flag will replace any fields marked as "secret" 
in your Ops Manager config with ((parametrized)) variables. If you would prefer to not
work with ((parametrized)) variables, you can substitute <code>--include-placeholders</code> with
<code>--include-credentials</code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>--include-credentials</code> WILL expose passwords and 
secrets in <em>plain text</em>. Therefore, <code>--include-placeholders</code> is recommended, but not required.</p>
</div>
<p><strong>Pipeline</strong></p>
<p>To add [<code>staged-director-config</code>] to your pipeline, you will need the following resources:</p>
<ul>
<li>the Platform Automation image</li>
<li>the Platform Automation tasks</li>
<li>a configuration path for your env file</li>
<li>a resource to store the exported configuration into</li>
</ul>
<p>Starting our Concourse pipeline, we need the following <code>resources</code>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.*tasks-(.*).zip</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.*image-(.*).tgz</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">git</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">private_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((configuration.private_key))</span>
    <span class="nt">uri</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((configuration.uri))</span>
    <span class="nt">branch</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">master</span>
</pre></div>
</td></tr></table></p>
<p>In our <code>jobs</code> section, we need a job that will interpolate the env file, pull down the 
Ops Manager director config, and store the director config in the configuration directory
(this can be the same resource as where the env is located, but will be stored in the <code>config</code>
instead of the <code>env</code> directory). In order to persist the director config in your git repo,
we first need to make a commit, detailing the change we made, and where in your git repo the 
change happened. A way to do this is shown below:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">staged-director-config</span>
  <span class="nt">plan</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">aggregate</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks</span>
          <span class="nt">params</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt">unpack</span><span class="p">:</span> <span class="nv">true</span><span class="p p-Indicator">}</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
          <span class="nt">params</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt">unpack</span><span class="p">:</span> <span class="nv">true</span><span class="p p-Indicator">}</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolate-env-creds</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/credhub-interpolate.yml</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">CREDHUB_CLIENT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-client))</span>
        <span class="nt">CREDHUB_SECRET</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-secret))</span>
        <span class="nt">CREDHUB_SERVER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-server))</span>
        <span class="nt">PREFIX</span><span class="p">:</span> <span class="s">&#39;/pipeline/vsphere&#39;</span>
        <span class="nt">INTERPOLATION_PATHS</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((foundation))/config</span>
        <span class="nt">SKIP_MISSING</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">input_mapping</span><span class="p">:</span>
        <span class="nt">files</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
      <span class="nt">output_mapping</span><span class="p">:</span>
        <span class="nt">interpolated-files</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolated-configs</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">staged-director-config</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/staged-director-config.yml</span>
      <span class="nt">input_mapping</span><span class="p">:</span>
        <span class="nt">env</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolated-env</span>
      <span class="nt">output_mapping</span><span class="p">:</span>
        <span class="nt">generated-config</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration/((foundation))/config</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((foundation))/env/env.yml</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">make-commit</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/make-git-commit.yml</span>
      <span class="nt">input_mapping</span><span class="p">:</span>
        <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
        <span class="nt">file-source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration/((foundation))/config</span>
      <span class="nt">output_mapping</span><span class="p">:</span>
        <span class="nt">repository-commit</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration-commit</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">FILE_SOURCE_PATH</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">director.yml</span>
        <span class="nt">FILE_DESTINATION_PATH</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config/((foundation))/director.yml</span>
        <span class="nt">GIT_AUTHOR_EMAIL</span><span class="p">:</span> <span class="s">&quot;git-author-email@example.com&quot;</span>
        <span class="nt">GIT_AUTHOR_NAME</span><span class="p">:</span> <span class="s">&quot;Git</span><span class="nv"> </span><span class="s">Author&quot;</span>
        <span class="nt">COMMIT_MESSAGE</span><span class="p">:</span> <span class="s">&quot;Update</span><span class="nv"> </span><span class="s">director.yml</span><span class="nv"> </span><span class="s">file&quot;</span>
    <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration-commit</span>
        <span class="nt">merge</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</td></tr></table>

<h2 id="retrieving-existing-product-configurations">Retrieving Existing Product Configurations</h2>
<p>If you would like to automate the configuration of your products, you first need to externalize
each product's configuration. Using Platform Automation, this is done using Docker or by adding a job to
the pipeline.</p>
<p><strong>Docker</strong></p>
<p>As an example, we are going to start with the PAS tile.
To get the currently configured PAS configuration, we have to:</p>
<ol>
<li>
<p>Import the image
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker import <span class="si">${</span><span class="nv">PLATFORM_AUTOMATION_IMAGE_TGZ</span><span class="si">}</span> platform-automation-image
</pre></div>
</td></tr></table>
Where <code>${PLATFORM_AUTOMATION_IMAGE_TGZ}</code> is the image file downloaded from Pivnet.</p>
</li>
<li>
<p>Then, you can use <code>docker run</code> to pass it arbitrary commands.
Here, we're running the <code>om</code> CLI to see what commands are available:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker run -it --rm -v <span class="nv">$PWD</span>:/workspace -w /workspace platform-automation-image <span class="se">\</span>
om -h
</pre></div>
</td></tr></table></p>
</li>
</ol>
<p>Note:  that this will have access read and write files in your current working directory.
If you need to mount other directories as well, you can add additional <code>-v</code> arguments.</p>
<p>The command we will use to extract the current director configuration is called 
<a href="../reference/task.html#staged-config"><code>staged-config</code></a>. This is an <code>om</code> command that calls
the Ops Manager API to pull down the currently configured product configuration given
a product slug. To run this using Docker, you will need the env file created above as <code>${ENV_FILE}</code>.
The product slug for the PAS tile, within Ops Manager, is <code>cf</code>. To find the slug of your
product, you can run the following docker command:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker run -it --rm -v <span class="nv">$PWD</span>:/workspace -w /workspace platform-automation-image <span class="se">\</span>
om --env <span class="si">${</span><span class="nv">ENV_FILE</span><span class="si">}</span> staged-products
</pre></div>
</td></tr></table>

<p>This will give you a table like the following:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="o">+</span><span class="c1">---------------+-----------------+</span>
<span class="o">|</span>     <span class="n">NAME</span>      <span class="o">|</span>     <span class="k">VERSION</span>     <span class="o">|</span>
<span class="o">+</span><span class="c1">---------------+-----------------+</span>
<span class="o">|</span> <span class="n">cf</span>            <span class="o">|</span> <span class="mi">2</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">x</span>           <span class="o">|</span>
<span class="o">|</span> <span class="n">p</span><span class="o">-</span><span class="n">healthwatch</span> <span class="o">|</span> <span class="mi">1</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">build</span><span class="p">.</span><span class="n">x</span>   <span class="o">|</span>
<span class="o">|</span> <span class="n">p</span><span class="o">-</span><span class="n">bosh</span>        <span class="o">|</span> <span class="mi">2</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">build</span><span class="p">.</span><span class="n">x</span>   <span class="o">|</span>
<span class="o">+</span><span class="c1">---------------+-----------------+</span>
</pre></div>
</td></tr></table>

<p>The values in the <code>NAME</code> column are the slugs of each product you have deployed. For this
<em>How to Guide</em>, we only have PAS and Healthwatch. </p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>p-bosh is the product slug of Ops Manager. However, <code>staged-config</code> <em><strong>cannot</strong></em> 
be used to extract the director config. To do so, you must use <code>staged-director-config</code></p>
</div>
<p>With the appropriate product <code>${SLUG}</code>, we can run the following docker command to pull down
the configuration of the chosen tile:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker run -it --rm -v <span class="nv">$PWD</span>:/workspace -w /workspace platform-automation-image <span class="se">\</span>
om --env <span class="si">${</span><span class="nv">ENV_FILE</span><span class="si">}</span> staged-config --product-name <span class="si">${</span><span class="nv">SLUG</span><span class="si">}</span> --include-placeholders
</pre></div>
</td></tr></table></p>
<p><code>--include-placeholders</code> is an optional flag, but highly recommended if you want a full
configuration for your tile. This flag will replace any fields marked as "secret" 
by the product in the config with ((parametrized)) variables. If you would prefer to not
work with ((parametrized)) variables, you can substitute <code>--include-placeholders</code> with
<code>--include-credentials</code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>--include-credentials</code> WILL expose passwords and 
secrets in <em>plain text</em>. Therefore, <code>--include-placeholders</code> is recommended, but not required.</p>
</div>
<p><strong>Pipeline</strong></p>
<p>To add [<code>staged-config</code>] to your pipeline, you will need the following resources:</p>
<ul>
<li>the Platform Automation image</li>
<li>the Platform Automation tasks</li>
<li>a configuration path for your env file</li>
<li>a resource to store the exported configuration into</li>
</ul>
<p>Starting our Concourse pipeline, we need the following resources:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.*tasks-(.*).zip</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.*image-(.*).tgz</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">git</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">private_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((configuration.private_key))</span>
    <span class="nt">uri</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((configuration.uri))</span>
    <span class="nt">branch</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">master</span>
</pre></div>
</td></tr></table></p>
<p>In our <code>jobs</code> section, we need a job that will interpolate the env file, pull down the 
product config, and store the director config in the configuration directory
(this can be the same resource as where the env is located, but will be stored in the <code>config</code>
instead of the <code>env</code> directory). In order to persist the product config in your git repo,
we first need to make a commit, detailing the change we made, and where in your git repo the 
change happened. A way to do this is shown below:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">staged-director-config</span>
  <span class="nt">plan</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">aggregate</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks</span>
          <span class="nt">params</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt">unpack</span><span class="p">:</span> <span class="nv">true</span><span class="p p-Indicator">}</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
          <span class="nt">params</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt">unpack</span><span class="p">:</span> <span class="nv">true</span><span class="p p-Indicator">}</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolate-env-creds</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/credhub-interpolate.yml</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">CREDHUB_CLIENT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-client))</span>
        <span class="nt">CREDHUB_SECRET</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-secret))</span>
        <span class="nt">CREDHUB_SERVER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-server))</span>
        <span class="nt">PREFIX</span><span class="p">:</span> <span class="s">&#39;/pipeline/vsphere&#39;</span>
        <span class="nt">INTERPOLATION_PATHS</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((foundation))/config</span>
        <span class="nt">SKIP_MISSING</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">input_mapping</span><span class="p">:</span>
        <span class="nt">files</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
      <span class="nt">output_mapping</span><span class="p">:</span>
        <span class="nt">interpolated-files</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolated-configs</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">staged-director-config</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/staged-director-config.yml</span>
      <span class="nt">input_mapping</span><span class="p">:</span>
        <span class="nt">env</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolated-env</span>
      <span class="nt">output_mapping</span><span class="p">:</span>
        <span class="nt">generated-config</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration/((foundation))/config</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((foundation))/env/env.yml</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">make-commit</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/make-git-commit.yml</span>
      <span class="nt">input_mapping</span><span class="p">:</span>
        <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
        <span class="nt">file-source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration/((foundation))/config</span>
      <span class="nt">output_mapping</span><span class="p">:</span>
        <span class="nt">repository-commit</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration-commit</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">FILE_SOURCE_PATH</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">director.yml</span>
        <span class="nt">FILE_DESTINATION_PATH</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config/((foundation))/director.yml</span>
        <span class="nt">GIT_AUTHOR_EMAIL</span><span class="p">:</span> <span class="s">&quot;git-author-email@example.com&quot;</span>
        <span class="nt">GIT_AUTHOR_NAME</span><span class="p">:</span> <span class="s">&quot;Git</span><span class="nv"> </span><span class="s">Author&quot;</span>
        <span class="nt">COMMIT_MESSAGE</span><span class="p">:</span> <span class="s">&quot;Update</span><span class="nv"> </span><span class="s">director.yml</span><span class="nv"> </span><span class="s">file&quot;</span>
    <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration-commit</span>
        <span class="nt">merge</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</td></tr></table>

<p>To retrieve the configuration for Healthwatch, we can simply duplicate the steps used for PAS. The <code>${SLUG}</code> 
for Healthwatch, as we retrieved from <code>staged-products</code>, is <code>p-healthwatch</code></p>
<h2 id="creating-a-pipeline-to-upgrade-ops-manager">Creating a Pipeline to Upgrade Ops Manager</h2>
<p>With the director configuration, product configurations, resources gathered, and config files created, 
we can finally begin to create a pipeline that will automatically update your Ops Manager. </p>
<p>At this point, your file tree should now look something like what is shown below. The following tree 
structure assumes that you are using a mix of vars files and credhub for each of the products used, 
for the Ops Manager director, and for the <code>upgrade-opsman</code> config file.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="err">├──</span> <span class="n">foundation</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">config</span>
<span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">cf</span><span class="p">.</span><span class="n">yml</span>
<span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">director</span><span class="p">.</span><span class="n">yml</span>
<span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">healthwatch</span><span class="p">.</span><span class="n">yml</span>
<span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">opsman</span><span class="p">.</span><span class="n">yml</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">env</span>
<span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">env</span><span class="p">.</span><span class="n">yml</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="k">state</span>
<span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="k">state</span><span class="p">.</span><span class="n">yml</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">vars</span>
<span class="err">│</span>       <span class="err">├──</span> <span class="n">cf</span><span class="o">-</span><span class="n">vars</span><span class="p">.</span><span class="n">yml</span>
<span class="err">│</span>       <span class="err">├──</span> <span class="n">director</span><span class="o">-</span><span class="n">vars</span><span class="p">.</span><span class="n">yml</span>
<span class="err">│</span>       <span class="err">├──</span> <span class="n">healthwatch</span><span class="o">-</span><span class="n">vars</span><span class="p">.</span><span class="n">yml</span>
<span class="err">│</span>       <span class="err">└──</span> <span class="n">opsman</span><span class="o">-</span><span class="n">vars</span><span class="p">.</span><span class="n">yml</span>
</pre></div>
</td></tr></table>

<p>Let's review the resources that are required by Concourse for upgrading Ops Manager:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">resources</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.*tasks-(.*).zip</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.*image-(.*).tgz</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">git</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">private_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((configuration.private_key))</span>
    <span class="nt">uri</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((configuration.uri))</span>
    <span class="nt">branch</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">master</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.installation))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation-(.*).zip</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">opsman-image</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">access_key_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.access_key_id))</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.buckets.pivnet_products))</span>
    <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.region_name))</span>
    <span class="nt">secret_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((s3.secret_access_key))</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">\[ops-manager,(.*)\].*.ova</span> <span class="c1"># vsphere ex: ops-manager-(.*).ova</span>

<span class="c1"># for exporting installation daily</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">daily-trigger</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">time</span>
  <span class="nt">source</span><span class="p">:</span>
    <span class="nt">interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">24h</span>
</pre></div>
</td></tr></table></p>
<p>Before we write the jobs portion of the pipeline, let's take a look at the tasks we should run
in order to function smoothly:</p>
<p><strong>a passing export installation</strong></p>
<p>In order for this job to run, a passing <code>export-installation</code> job must have been completed.
Again, by exporting the Ops Manager installation, we can ensure that we have a backup in-case of some
error. With a backed up installation, <code>upgrade-opsman</code> can be run over-and-over regardless of which stage
the task failed during. This is also important in case something happens to the VM externally (whether accidentally 
deleted, or a similar disaster occurs). If something <em>does</em> happen to the original Ops Manager VM, this 
installation can be imported by any newly created Ops Manager VM. Please refer to 
<a href="#valid-exported-ops-manager-installation">the Valid exported Ops Manager installation</a> 
section for details on this job. </p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is recommended to persist the zip file exported from export-installation
 to an external file store (eg S3) on a regular basis.
 The exported installation can restore the Ops Manager
 to a working state if it is non-functional.</p>
</div>
<p><strong>interpolated env and config</strong></p>
<p>This job uses a mix of secret and non-secret variables that are interpolated from both Credhub and
vars files. This can be seen in both the <code>interpolate-config-creds</code> and <code>interpolate-env-creds</code> tasks.
These tasks return the <code>interpolated-config</code> and <code>interpolated-env</code> files that are further used by
the <code>upgrade-opsman</code> task. For further information on how this works and how you can set it up, see the 
<a href="#parametrizing-secrets-and-using-credhub-interpolate">Parameterizing Secrets</a> section of this guide
and the <a href="../configuration-management/secrets-handling.html">Secrets Handling</a> page.</p>
<p><strong>ensure commit</strong></p>
<p>The <code>ensure</code> portion of this pipeline is used to ensure that the state file is committed to the repository,
whether upgrading succeeded or failed. This way, the repository always has the most up to date <code>state.yml</code> file
that reflects the current condition of Ops Manager. This is important so that subsequent runs of this task
or other tasks don't attempt to target a Ops Manager VM that is deleted or in a bad state.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>When attempting to trouble-shoot the <code>upgrade-opsman</code> task, it may be necessary to manually remove
the <code>vm_id</code> from your <code>state.yml</code> file. If the Ops Manager VM is in an unresponsive state or the 
<code>state.yml</code> file does not reflect the most up to date VM information, (for example, if 
the <code>ensure</code> fails for some reason) manually removing the <code>vm_id</code> will allow the upgrade task to 
start in a fresh state and create the VM during the next run. </p>
</div>
<p><strong>upgrade ops man task</strong></p>
<p>The <code>upgrade-opsman</code> task uses all the inputs provided, including the interpolated files, the 
Ops Manager image, the <code>state.yml</code> file, the <code>env.yml</code> file, and the <code>opsman.yml</code> file,
to run. Upon completion, Ops Manager will be upgraded. The following flowchart gives a high level overview
of how the task makes decisions for an upgrade:</p>
<div class="mermaid">
graph TD;
  versionChk[Is the existing Ops Manager version less than the Ops Manager image?];
  versionError[Version Check Error];
  delete[Delete the existing Ops Manager VM];
  create[Create a new Ops Manager VM];
  iaasErr[IAAS CLI error];
  import[Import the provided Installation];
  iaasErr2[IAAS CLI error];
  versionChk -- No --> versionError;
  versionChk -- Yes --> delete;
  delete -- Success --> create;
  delete -- Failure --> iaasErr;
  create -- Success --> import ;
  create -- Failure --> iaasErr2;
</div>

<p>On successive invocations of the task, it may offer different behaviour than the previous run.
This aids in recovering from failures (ie: from an IAAS) that occur. For examples on common errors and 
troubleshooting, see the <a href="#troubleshooting">Troubleshooting</a> section.</p>
<p><strong>apply director changes task</strong></p>
<p>Finally, using the interpolated environment file, the <code>apply-director-changes</code> task will apply any remaining upgrade
changes to Ops Manager. Upon completion of this task, upgrading Ops Manager is now complete. </p>
<p>By placing all of these tasks into a pipeline, you can get something like the following:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">jobs</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">export-installation</span>
  <span class="nt">serial</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">plan</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">aggregate</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">daily-trigger</span>
          <span class="nt">trigger</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">unpack</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">unpack</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">variable</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolate-env-creds</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/credhub-interpolate.yml</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">CREDHUB_CLIENT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-client))</span>
        <span class="nt">CREDHUB_SECRET</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-secret))</span>
        <span class="nt">CREDHUB_SERVER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-server))</span>
        <span class="nt">PREFIX</span><span class="p">:</span> <span class="s">&#39;/pipeline/vsphere&#39;</span>
        <span class="nt">INTERPOLATION_PATHS</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((foundation))/config</span>
        <span class="nt">SKIP_MISSING</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">input_mapping</span><span class="p">:</span>
        <span class="nt">files</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
      <span class="nt">output_mapping</span><span class="p">:</span>
        <span class="nt">interpolated-files</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolated-configs</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">export-installation</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/export-installation.yml</span>
      <span class="nt">input_mapping</span><span class="p">:</span>
        <span class="nt">env</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolated-env</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((foundation))/env/env.yml</span>
        <span class="nt">INSTALLATION_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation-$timestamp.zip</span>
    <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation/installation*.zip</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">upgrade-opsman</span>
  <span class="nt">plan</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">aggregate</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
        <span class="nt">params</span><span class="p">:</span>
          <span class="nt">unpack</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks</span>
          <span class="nt">params</span><span class="p">:</span>
            <span class="nt">unpack</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">opsman-image</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">installation</span>
          <span class="nt">passed</span><span class="p">:</span> <span class="p p-Indicator">[</span> <span class="nv">export-installation</span> <span class="p p-Indicator">]</span>
        <span class="p p-Indicator">-</span> <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolate-env-creds</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/credhub-interpolate.yml</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">CREDHUB_CLIENT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-client))</span>
        <span class="nt">CREDHUB_SECRET</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-secret))</span>
        <span class="nt">CREDHUB_SERVER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-server))</span>
        <span class="nt">PREFIX</span><span class="p">:</span> <span class="s">&#39;/pipeline/vsphere&#39;</span>
        <span class="nt">INTERPOLATION_PATHS</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((foundation))/env</span>
        <span class="nt">SKIP_MISSING</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">input_mapping</span><span class="p">:</span>
        <span class="nt">files</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
      <span class="nt">output_mapping</span><span class="p">:</span>
        <span class="nt">interpolated-files</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolated-env</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolate-config-creds</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/credhub-interpolate.yml</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">CREDHUB_CLIENT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-client))</span>
        <span class="nt">CREDHUB_SECRET</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-secret))</span>
        <span class="nt">CREDHUB_SERVER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((credhub-server))</span>
        <span class="nt">PREFIX</span><span class="p">:</span> <span class="s">&#39;/pipeline/vsphere&#39;</span>
        <span class="nt">INTERPOLATION_PATHS</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((foundation))/config</span>
        <span class="nt">SKIP_MISSING</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">input_mapping</span><span class="p">:</span>
        <span class="nt">files</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
      <span class="nt">output_mapping</span><span class="p">:</span>
        <span class="nt">interpolated-files</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolated-configs</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">upgrade-opsman</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/upgrade-opsman.yml</span>
      <span class="nt">input_mapping</span><span class="p">:</span>
        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">opsman-image</span>
        <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
        <span class="nt">config</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolated-configs</span>
        <span class="nt">env</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolated-env</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">VARS_FILES</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vars/((foundation))/vars/opsman-vars.yml</span>
        <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((foundation))/env/env.yml</span>
        <span class="nt">OPSMAN_CONFIG_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((foundation))/config/opsman.yml</span>
        <span class="nt">STATE_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((foundation))/state/state.yml</span>
      <span class="nt">ensure</span><span class="p">:</span>
        <span class="nt">do</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">make-commit</span>
            <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
            <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/make-git-commit.yml</span>
            <span class="nt">input_mapping</span><span class="p">:</span>
              <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
              <span class="nt">file-source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration/((foundation))/config</span>
            <span class="nt">output_mapping</span><span class="p">:</span>
              <span class="nt">repository-commit</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration-commit</span>
            <span class="nt">params</span><span class="p">:</span>
              <span class="nt">FILE_SOURCE_PATH</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cf.yml</span>  <span class="c1"># the filename will be called ${SLUG}.yml</span>
              <span class="nt">FILE_DESTINATION_PATH</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config/((foundation))/director.yml</span>
              <span class="nt">GIT_AUTHOR_EMAIL</span><span class="p">:</span> <span class="s">&quot;git-author-email@example.com&quot;</span>
              <span class="nt">GIT_AUTHOR_NAME</span><span class="p">:</span> <span class="s">&quot;Git</span><span class="nv"> </span><span class="s">Author&quot;</span>
              <span class="nt">COMMIT_MESSAGE</span><span class="p">:</span> <span class="s">&quot;Update</span><span class="nv"> </span><span class="s">director.yml</span><span class="nv"> </span><span class="s">file&quot;</span>
          <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
            <span class="nt">params</span><span class="p">:</span>
              <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration-commit</span>
              <span class="nt">merge</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
          <span class="p p-Indicator">-</span> <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
            <span class="nt">params</span><span class="p">:</span>
              <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configuration-commit</span>
              <span class="nt">merge</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apply-director-changes</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-image</span>
      <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">platform-automation-tasks/tasks/apply-director-changes.yml</span>
      <span class="nt">input_mapping</span><span class="p">:</span>
        <span class="nt">env</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">interpolated-env</span>
      <span class="nt">params</span><span class="p">:</span>
        <span class="nt">ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">((foundation))/env/env.yml</span>
</pre></div>
</td></tr></table></p>
<p>With your pipeline completed, you are now ready to trigger <code>export-installation</code>, and get started!</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>When you are upgrading your Ops Manager you may get version check or IaaS CLI errors. For information about troubleshooting these errors, see <a href="../upgrade.html#version-check-errors"><code>Version Check Errors</code></a> and <a href="../upgrade.html#iaas-cli-errors"><code>IaaS CLI Errors</code></a> below.</p>
<h3 id="version-check-errors">Version Check Errors</h3>
<p>1) <b>Downgrading is not supported by Ops Manager</b> (Manual Intervention Required)</p>
<ul>
<li>Ops Manager does not support downgrading to a lower version.</li>
<li>SOLUTION: Try the upgrade again with a newer version of Ops Manager.</li>
</ul>
<p>2) <b>Could not authenticate with Ops Manager</b> (Manual Intervention Required)</p>
<ul>
<li>Credentials provided in the auth file do not match the credentials of an already deployed Ops Manager.</li>
<li>SOLUTION: To change the credentials when upgrading an Ops Manager, you must update the password in your
Account Settings. Then, you will need to update the following two files with the changes:
  <a href="../configuration-management/configure-auth.html#generating-an-auth-file"><code>auth.yml</code></a>
  <a href="../configuration-management/configure-env.html#generating-an-env-file"><code>env.yml</code></a></li>
</ul>
<p>3) <b>The Ops Manager API is inaccessible</b> (Recoverable)</p>
<ul>
<li>The task could not communicate with Ops Manager.</li>
<li>SOLUTION: Rerun the <a href="../reference/task.html#upgrade-opsman"><code>upgrade-opsman</code></a> task. The task will assume that the Ops Manager VM is not
created, and will run the <a href="../reference/task.html#create-vm"><code>create-vm</code></a> and
<a href="../reference/task.html#import-installation"><code>import-installation</code></a> tasks.</li>
</ul>
<h3 id="iaas-cli-errors">IAAS CLI Errors</h3>
<p>1) When the CLI for a supported IAAS fails for any reason (i.e., bad network, outage, etc) we treat this as
an IAAS CLI error. The following tasks can return an error from the IAAS's CLI: <a href="../reference/task.html#delete-vm"><code>delete-vm</code></a>, <a href="../reference/task.html#create-vm"><code>create-vm</code></a></p>
<ul>
<li>SOLUTION: The specific error will be returned as output, but <i><b>most errors can simply be fixed by
re-running the <code>upgrade-opsman</code> task.</b></i></li>
</ul>
<h3 id="todo">TODO</h3>
<p>Defining yaml anchors, triggers, time, etc.</p></article></div></div></main><style>
    .footer-not-link {
        color: hsla(0,0%,100%,.7);
    }
</style>

<!-- Application footer -->
<footer class="md-footer">

    <!-- Link to previous and/or next page --><!-- Further information -->
    <div class="md-footer-meta md-typeset">
        <div class="md-footer-meta__inner md-grid">

            <!-- Copyright and theme information -->
            <div class="md-footer-copyright">
                <a href="https://pivotal.io/privacy-policy" target="_blank">
                    Privacy Policy
                </a>
                |
                <a href="https://pivotal.io/legal/" target="_blank">
                    Terms of Use
                </a>
                |
                <a href="https://pivotal.io" target="_blank">
                    Pivotal
                </a>
            </div>

            <div class="md-footer-social footer-not-link">
                    Pivotal Documentation © 2019 Pivotal Software, Inc. All Rights Reserved
            </div>

        </div>
    </div>
</footer></div><script src="../assets/javascripts/application.b260a35d.js"></script><script>app.initialize({version:"1.0.4",url:{base:".."}})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/7.1.2/mermaid.min.js"></script></body></html>